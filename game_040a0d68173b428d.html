<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ¥è¯†æ¢é™©è½¬è½¬ä¹ - è¶£å‘³æ•™æ¡ˆ (PPTæ¼”ç¤ºç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --text-color: #2C3E50;
            --bg-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-family);
            background: var(--bg-gradient);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- UI ç»„ä»¶ --- */
        .hidden { display: none !important; }
        .btn {
            background: #fff;
            border: 4px solid var(--text-color);
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            box-shadow: 0 6px 0 var(--text-color);
            transition: transform 0.1s, box-shadow 0.1s;
            margin: 10px;
            text-align: center;
            outline: none;
            appearance: none;
        }
        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 var(--text-color);
        }
        .btn-primary { background: var(--primary-color); color: white; border-color: #c0392b; box-shadow: 0 6px 0 #c0392b; }
        .btn-success { background: var(--secondary-color); color: white; border-color: #16a085; box-shadow: 0 6px 0 #16a085; }

        /* å…¨å±æŒ‰é’® */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 5000;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            border: 2px solid var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
        }
        .fullscreen-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        /* --- åœºæ™¯å®¹å™¨ --- */
        #app {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 1. åŠ è½½é¡µ */
        #loading-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .loader {
            width: 50px; height: 50px;
            border: 5px solid var(--secondary-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* 2. ä¸»èœå• */
        #main-menu {
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s;
        }
        .title {
            font-size: 3rem;
            color: white;
            text-shadow: 3px 3px 0px var(--text-color);
            margin-bottom: 40px;
            text-align: center;
            padding: 0 20px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            width: 90%;
        }
        .menu-card {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 3px solid transparent;
        }
        .menu-card:hover { transform: scale(1.05); border-color: var(--secondary-color); }
        .menu-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .menu-text { font-size: 1.5rem; font-weight: bold; color: var(--text-color); }

        /* 3. æ¸¸æˆä¸»åœºæ™¯ */
        #game-stage {
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .top-bar {
            height: 80px;
            min-height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding-right: 80px;
            z-index: 100;
        }
        .score-board { font-size: 1.5rem; font-weight: bold; color: var(--text-color); }

        .game-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        /* --- æ¨¡å—A: æ‰­è›‹æœº --- */
        #gacha-container { position: relative; width: 360px; height: 500px; }
        #gacha-canvas { width: 100%; height: 100%; }
        .gacha-controls {
            position: absolute; bottom: -60px; left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* --- æ¨¡å—B: å¤§è½¬ç›˜ --- */
        #wheel-container { position: relative; width: 400px; height: 400px; }
        #wheel-canvas { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .wheel-pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; background: var(--primary-color);
            clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10;
        }
        .wheel-btn {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80px; height: 80px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid var(--primary-color);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer;
            z-index: 11;
            user-select: none;
        }

        /* --- æ¨¡å—C: å¡ç‰‡å¢™ --- */
        #card-grid {
            display: grid;
            grid-template-columns: repeat(3, 120px);
            grid-template-rows: repeat(3, 120px);
            gap: 15px;
        }
        .card {
            width: 100%; height: 100%;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            font-size: 2rem;
        }
        .card-front { background: var(--secondary-color); color: white; border: 4px solid white; }
        .card-back { 
            background: white; 
            transform: rotateY(180deg); 
            color: var(--text-color); 
            padding: 5px; 
            font-size: 0.9rem; 
            border: 4px solid var(--secondary-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card-img-container {
            width: 80px;
            height: 80px;
            margin-bottom: 5px;
            overflow: hidden;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
        }
        .card-img-small {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 4. ä»»åŠ¡å¼¹çª— (è®¡åˆ†) */
        #task-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 2200;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        #task-modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            border-radius: 20px; padding: 30px;
            text-align: center;
            position: relative;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-type { font-size: 1.2rem; color: #888; margin-bottom: 10px; }
        .modal-title { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 20px; font-weight: bold; }
        .modal-desc { font-size: 1.2rem; margin-bottom: 30px; line-height: 1.5; color: #555; }
        .star-rating { font-size: 2rem; margin-bottom: 20px; color: #ddd; cursor: pointer; }
        .star-rating span.active { color: gold; }

        /* 5. å›¾ç‰‡æ”¾å¤§å±•ç¤ºå±‚ (PPTæ¨¡å¼) */
        #image-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2100;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .viewer-content {
            text-align: center; color: white;
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .viewer-img-container {
            max-width: 80vw;
            max-height: 60vh;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            background: #fff;
        }
        .viewer-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .viewer-title { 
            font-size: 4rem; 
            margin: 10px 0; 
            font-weight: bold; 
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .viewer-hint { 
            font-size: 1.5rem; 
            color: #ddd; 
            margin-bottom: 40px; 
            font-weight: normal;
        }

        /* 6. å¥–åŠ±ç‰¹æ•ˆå±‚ */
        #reward-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 3000;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        @media (max-width: 600px) {
            .title { font-size: 2rem; }
            .menu-grid { grid-template-columns: 1fr; }
            #card-grid { grid-template-columns: repeat(3, 90px); grid-template-rows: repeat(3, 90px); }
            #wheel-container { width: 300px; height: 300px; }
            #gacha-container { width: 300px; height: 400px; }
            .viewer-title { font-size: 2rem; }
            .viewer-hint { font-size: 1rem; }
        }
        
        @media (max-height: 600px) {
            .modal-content { max-height: 90vh; overflow-y: auto; }
            .viewer-img-container { max-height: 50vh; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- å…¨å±æ¼”ç¤ºæŒ‰é’® -->
    <button class="fullscreen-btn" onclick="gameManager.toggleFullScreen()" title="å…¨å±æ¼”ç¤ºæ¨¡å¼">â›¶</button>

    <!-- åŠ è½½é¡µ -->
    <div id="loading-screen">
        <div class="loader"></div>
        <p style="margin-top:20px; font-weight:bold; color:var(--text-color);">æ­£åœ¨å‡†å¤‡æ•™æ¡ˆé“å…·...</p>
        <p style="margin-top:10px; font-size:0.9rem; color:#666;">å»ºè®®ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®å…¨å±æ’­æ”¾ï¼Œä½“éªŒæ›´ä½³</p>
    </div>

    <!-- ä¸»èœå• -->
    <div id="main-menu" class="hidden">
        <h1 class="title">âœ¨ çŸ¥è¯†æ¢é™©è½¬è½¬ä¹ âœ¨</h1>
        <div class="menu-grid">
            <div class="menu-card" onclick="gameManager.enterModule('recitation')">
                <span class="menu-icon">ğŸ’Š</span>
                <div class="menu-text">å¿…èƒŒè¯¾æ–‡</div>
                <div style="font-size:0.8rem; color:#888;">æ‰­è›‹æœºæŒ‘æˆ˜</div>
            </div>
            <div class="menu-card" onclick="gameManager.enterModule('accumulation')">
                <span class="menu-icon">ğŸ¡</span>
                <div class="menu-text">æ—¥ç§¯æœˆç´¯</div>
                <div style="font-size:0.8rem; color:#888;">å¹¸è¿å¤§è½¬ç›˜</div>
            </div>
            <div class="menu-card" onclick="gameManager.enterModule('speaking')">
                <span class="menu-icon">ğŸ–¼ï¸</span>
                <div class="menu-text">çœ‹å›¾è¯´è¯</div>
                <div style="font-size:0.8rem; color:#888;">ç¥å¥‡ç¿»ç¿»å¡</div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»èˆå° -->
    <div id="game-stage" class="hidden">
        <div class="top-bar">
            <button class="btn" style="padding:5px 15px; font-size:1rem;" onclick="gameManager.goHome()">ğŸ  é¦–é¡µ</button>
            <div style="font-size:1.2rem; font-weight:bold; text-align:center;" id="module-title">æ¨¡å—æ ‡é¢˜</div>
            <div class="score-board">
                â­ <span id="score-display">0</span>
            </div>
        </div>

        <div class="game-content" id="content-container">
            <!-- åŠ¨æ€å†…å®¹å°†è¢«æ³¨å…¥è¿™é‡Œ -->
        </div>

        <div style="height: 50px; display:flex; align-items:center; justify-content:center; color:#fff; background:rgba(0,0,0,0.2); width:100%; text-align:center;">
            <span id="instruction-text">è¯·é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¼€å§‹ï¼</span>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§é¢„è§ˆå¼¹çª— (PPTå±•ç¤ºæ¨¡å¼) -->
<div id="image-viewer-modal" class="hidden">
    <div class="viewer-content">
        <div class="viewer-img-container">
            <img id="viewer-img" class="viewer-img" src="" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
        <div class="viewer-title" id="viewer-title">å›¾ç‰‡æ ‡é¢˜</div>
        <p class="viewer-hint">è¯·åŒå­¦ä»¬ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿ</p>
        <button class="btn btn-primary" onclick="gameManager.hideImageViewerAndShowTask()">ğŸ—£ï¸ æˆ‘å‡†å¤‡å¥½å›ç­”äº†</button>
    </div>
</div>

<!-- ä»»åŠ¡è¯„åˆ†å¼¹çª— -->
<div id="task-modal">
    <div class="modal-content">
        <div class="modal-type" id="modal-type">ä»»åŠ¡ç±»å‹</div>
        <div class="modal-title" id="modal-title">é¢˜ç›®åç§°</div>
        <!-- <div class="modal-desc" id="modal-desc">è¿™é‡Œæ˜¯ä»»åŠ¡æè¿°æˆ–å…·ä½“å†…å®¹...</div> -->
        
        <div class="star-rating" id="rating-stars">
            <span onclick="scoreSystem.setTempScore(1)">â˜…</span>
            <span onclick="scoreSystem.setTempScore(2)">â˜…</span>
            <span onclick="scoreSystem.setTempScore(3)">â˜…</span>
        </div>
        
        <button class="btn btn-success" onclick="scoreSystem.submitScore()">âœ… å®Œæˆä»»åŠ¡</button>
        <button class="btn" style="font-size:1rem; padding: 10px 20px; border-color:#ccc; color:#888; margin-top:10px;" onclick="gameManager.closeModal()">è·³è¿‡</button>
    </div>
</div>

<!-- å¥–åŠ±ç‰¹æ•ˆ Canvas -->
<canvas id="reward-overlay"></canvas>

<script>
/**
 * æ¸¸æˆæ•°æ®é…ç½®
 */
const GAME_DATA = {
    recitation: {
        title: "å¿…èƒŒè¯¾æ–‡ (æ‰­è›‹æœº)",
        instruction: "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰­ä¸€æ‰­ï¼ŒèƒŒè¯µæ‰å‡ºæ¥çš„è¯¾æ–‡ï¼",
        items: [
            { id: 1, title: 'é‡‘æœ¨æ°´ç«åœŸ', desc: 'ä¸€äºŒä¸‰å››äº”ï¼Œé‡‘æœ¨æ°´ç«åœŸ...' },
            { id: 2, title: 'ç§‹å¤©', desc: 'å¤©æ°”å‡‰äº†ï¼Œæ ‘å¶é»„äº†...' },
            { id: 3, title: 'æ±Ÿå—', desc: 'æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°...' },
            { id: 4, title: 'é›ªåœ°é‡Œçš„å°ç”»å®¶', desc: 'ä¸‹é›ªå•¦ï¼Œä¸‹é›ªå•¦ï¼é›ªåœ°é‡Œæ¥äº†ä¸€ç¾¤å°ç”»å®¶...' },
            { id: 5, title: 'å¯¹éŸµæ­Œ', desc: 'äº‘å¯¹é›¨ï¼Œé›ªå¯¹é£ã€‚èŠ±å¯¹æ ‘ï¼Œé¸Ÿå¯¹è™«...' },
            { id: 6, title: 'å‡å›½æ——', desc: 'äº”æ˜Ÿçº¢æ——ï¼Œæˆ‘ä»¬çš„å›½æ——...' },
            { id: 7, title: 'å°å°çš„èˆ¹', desc: 'å¼¯å¼¯çš„æœˆå„¿å°å°çš„èˆ¹...' },
            { id: 8, title: 'æ¯”å°¾å·´', desc: 'è°çš„å°¾å·´é•¿ï¼Ÿè°çš„å°¾å·´çŸ­ï¼Ÿ...' }
        ]
    },
    accumulation: {
        title: "æ—¥ç§¯æœˆç´¯ (å¤§è½¬ç›˜)",
        instruction: "ç‚¹å‡»ä¸­é—´çš„æŒ‰é’®è½¬åŠ¨è½¬ç›˜ï¼Œå¤§å£°æœ—è¯»å¹¶è§£é‡Šï¼",
        items: [
            { id: 101, title: 'å’é¹…', desc: 'é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œ...' },
            { id: 102, title: 'ç”»', desc: 'è¿œçœ‹å±±æœ‰è‰²ï¼Œè¿‘å¬æ°´æ— å£°...' },
            { id: 103, title: 'æ‚¯å†œ', desc: 'é”„ç¦¾æ—¥å½“åˆï¼Œæ±—æ»´ç¦¾ä¸‹åœŸ...' },
            { id: 104, title: 'å¤æœ—æœˆè¡Œ', desc: 'å°æ—¶ä¸è¯†æœˆï¼Œå‘¼ä½œç™½ç‰ç›˜...' },
            { id: 105, title: 'ç§ç“œå¾—ç“œ', desc: 'ç§ç“œå¾—ç“œï¼Œç§è±†å¾—è±†ã€‚ï¼ˆè°šè¯­ï¼‰' },
            { id: 106, title: 'å‰äººæ ½æ ‘', desc: 'å‰äººæ ½æ ‘ï¼Œåäººä¹˜å‡‰ã€‚ï¼ˆè°šè¯­ï¼‰' },
            { id: 107, title: 'ç™¾å°ºç«¿å¤´', desc: 'ç™¾å°ºç«¿å¤´ï¼Œæ›´è¿›ä¸€æ­¥ã€‚ï¼ˆè°šè¯­ï¼‰' },
            { id: 108, title: 'ä¸€å¹´ä¹‹è®¡', desc: 'ä¸€å¹´ä¹‹è®¡åœ¨äºæ˜¥ï¼Œä¸€æ—¥ä¹‹è®¡åœ¨äºæ™¨ã€‚' }
        ]
    },
    speaking: {
        title: "çœ‹å›¾è¯´è¯ (ç¿»ç¿»ä¹)",
        instruction: "ç‚¹å‡»ä¸€å¼ å¡ç‰‡ï¼Œæ”¾å¤§è§‚å¯Ÿå›¾ç‰‡å¹¶è¿›è¡Œæè¿°ï¼",
        items: [
            { id: 201, title: 'åœºæ™¯ä¸€', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/cad938e390b14eadac50085ea68888ab.jpg' },
            { id: 202, title: 'åœºæ™¯äºŒ', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/148c918c71e54b98a4172f143e67136c.jpg' },
            { id: 203, title: 'åœºæ™¯ä¸‰', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/f8809bf34e124a2c9818902efbb3f75f.jpg' },
            { id: 204, title: 'åœºæ™¯å››', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/230c54b6a46246b5a9a1bf6e3642bf34.jpg' },
            { id: 205, title: 'åœºæ™¯äº”', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/f01506970a444088884b51bbafcfd979.jpg' },
            { id: 206, title: 'åœºæ™¯å…­', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/9670afac33fd488ba83907b8e071b210.jpg' },
            { id: 207, title: 'åœºæ™¯ä¸ƒ', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/40f141664eba4ff3bd00106150d4cb3a.jpg' },
            { id: 208, title: 'åœºæ™¯å…«', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/a99e2b696ffa4d43a98768d91ced9f1e.jpg' },
            { id: 209, title: 'åœºæ™¯ä¹', desc: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡ï¼Œæè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆ', icon: 'https://guonei-cos.koocdn.com/common/d09e327b62d14b6eb4358f81125c2d7e.jpg' }
        ]
    }
};

/**
 * ç®€æ˜“éŸ³æ•ˆæ§åˆ¶å™¨
 */
const AudioCtrl = {
    ctx: null,
    playTone(freq, type, duration) {
        if (!this.ctx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                this.ctx = new AudioContext();
            }
        }
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume().catch(console.error);
        }
        
        if (!this.ctx) return;

        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    click() { this.playTone(600, 'sine', 0.1); },
    win() { 
        this.playTone(400, 'square', 0.1);
        setTimeout(() => this.playTone(600, 'square', 0.1), 100);
        setTimeout(() => this.playTone(800, 'square', 0.3), 200);
    },
    pop() { this.playTone(300, 'triangle', 0.1); }
};

/**
 * æ¸¸æˆæ ¸å¿ƒç®¡ç†å™¨
 */
const gameManager = {
    state: {
        score: 0,
        currentModule: null,
        currentItem: null,
        animationId: null
    },

    init() {
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if(loader) loader.classList.add('hidden');
            const menu = document.getElementById('main-menu');
            if(menu) menu.classList.remove('hidden');
        }, 1500);

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowRight') {
                if(document.getElementById('task-modal').classList.contains('active')) {
                    this.closeModal();
                } else if (!document.getElementById('image-viewer-modal').classList.contains('hidden')) {
                    this.hideImageViewerAndShowTask();
                }
            }
        });
    },

    toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(console.error);
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    },

    enterModule(moduleKey) {
        AudioCtrl.click();
        this.state.currentModule = moduleKey;
        const moduleData = GAME_DATA[moduleKey];

        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('game-stage').classList.remove('hidden');
        
        document.getElementById('module-title').innerText = moduleData.title;
        document.getElementById('instruction-text').innerText = moduleData.instruction;

        const container = document.getElementById('content-container');
        container.innerHTML = ''; 

        if (moduleKey === 'recitation') {
            this.initGacha(container);
        } else if (moduleKey === 'accumulation') {
            this.initWheel(container);
        } else if (moduleKey === 'speaking') {
            this.initCards(container);
        }
    },

    goHome() {
        AudioCtrl.click();
        
        // åœæ­¢åŠ¨ç”»å¾ªç¯
        if (this.state.animationId) {
            cancelAnimationFrame(this.state.animationId);
            this.state.animationId = null;
        }
        particleSystem.stop();

        // å½»åº•æ¸…ç©ºå®¹å™¨
        document.getElementById('content-container').innerHTML = '';
        
        // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
        document.getElementById('task-modal').classList.remove('active');
        document.getElementById('image-viewer-modal').classList.add('hidden');

        document.getElementById('game-stage').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
    },

    showTask(item) {
        this.state.currentItem = item;
        const modal = document.getElementById('task-modal');
        document.getElementById('modal-type').innerText = GAME_DATA[this.state.currentModule].title;
        document.getElementById('modal-title').innerText = item.title;
        // document.getElementById('modal-desc').innerText = item.desc;
        
        scoreSystem.tempScore = 0;
        document.querySelectorAll('.star-rating span').forEach(s => s.classList.remove('active'));

        modal.classList.add('active');
        AudioCtrl.pop();
    },

    closeModal() {
        document.getElementById('task-modal').classList.remove('active');
    },

    // --- å›¾ç‰‡æ”¾å¤§é¢„è§ˆé€»è¾‘ ---
    showImageViewer(item) {
        this.state.currentItem = item;
        const viewer = document.getElementById('image-viewer-modal');
        
        document.getElementById('viewer-img').src = item.icon; 
        document.getElementById('viewer-title').innerText = item.title;
        
        viewer.classList.remove('hidden');
        AudioCtrl.pop();
    },

    hideImageViewerAndShowTask() {
        document.getElementById('image-viewer-modal').classList.add('hidden');
        this.showTask(this.state.currentItem);
    },

    // --- æ¨¡å—åˆå§‹åŒ–é€»è¾‘ ---
    
    initGacha(container) {
        const wrapper = document.createElement('div');
        wrapper.id = 'gacha-container';
        wrapper.innerHTML = `
            <canvas id="gacha-canvas" width="360" height="500"></canvas>
            <div class="gacha-controls">
                <button class="btn btn-primary" id="gacha-btn">ğŸŸ¢ æ‰­ä¸€æ‰­</button>
            </div>
        `;
        container.appendChild(wrapper);

        const canvas = document.getElementById('gacha-canvas');
        if(!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const balls = [];
        const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9F43', '#54A0FF'];

        for(let i=0; i<8; i++) {
            balls.push({
                x: 180, y: 300, r: 25,
                color: colors[i % colors.length],
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10
            });
        }

        let isShaking = false;

        const loop = () => {
            if (!document.getElementById('gacha-canvas')) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // æœºèº«
            ctx.fillStyle = '#eee';
            ctx.beginPath(); ctx.arc(180, 200, 160, 0, Math.PI*2); ctx.fill(); 
            ctx.strokeStyle = '#ddd'; ctx.lineWidth = 5; ctx.stroke(); 
            
            // åº•åº§
            ctx.fillStyle = '#FF6B6B';
            ctx.fillRect(60, 320, 240, 150);
            ctx.fillStyle = '#222';
            ctx.fillRect(110, 380, 140, 60);

            // çƒä½“
            balls.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                ctx.fillStyle = b.color;
                ctx.fill();
                ctx.stroke();
                
                ctx.beginPath(); ctx.arc(b.x-8, b.y-8, 6, 0, Math.PI*2); 
                ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fill();

                if (isShaking) {
                    b.x += (Math.random()-0.5) * 20;
                    b.y += (Math.random()-0.5) * 20;
                    const dist = Math.hypot(b.x - 180, b.y - 200);
                    if (dist > 140) { b.x = 180; b.y = 200; }
                } else {
                    if (b.y < 300) b.y += 2;
                }
            });

            this.state.animationId = requestAnimationFrame(loop);
        };
        loop();

        document.getElementById('gacha-btn').onclick = () => {
            if(isShaking) return;
            isShaking = true;
            AudioCtrl.playTone(200, 'sawtooth', 0.5);
            
            setTimeout(() => {
                isShaking = false;
                const items = GAME_DATA.recitation.items;
                const item = items[Math.floor(Math.random() * items.length)];
                this.showTask(item);
            }, 1500);
        };
    },

    initWheel(container) {
        const wrapper = document.createElement('div');
        wrapper.id = 'wheel-container';
        wrapper.innerHTML = `
            <canvas id="wheel-canvas" width="400" height="400"></canvas>
            <div class="wheel-pointer"></div>
            <div class="wheel-btn" id="spin-btn">å¼€å§‹</div>
        `;
        container.appendChild(wrapper);

        const canvas = document.getElementById('wheel-canvas');
        if(!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const items = GAME_DATA.accumulation.items;
        const len = items.length;
        const arc = Math.PI * 2 / len;
        const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A8E6CF', '#FF8B94', '#98DDCA', '#D5ECC2', '#FFD3B6'];

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(200, 200);
            
            const startAngle = -Math.PI / 2;

            for(let i=0; i<len; i++) {
                const angle = startAngle + i * arc; 
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.arc(0, 0, 190, angle, angle + arc);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.save();
                
                ctx.rotate(angle + arc/2);
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(items[i].title, 170, 5);
                ctx.restore();
            }
            ctx.setTransform(1, 0, 0, 1, 0, 0);
        }
        drawWheel();

        let currentRotation = 0;
        let isSpinning = false;

        document.getElementById('spin-btn').onclick = () => {
            if(isSpinning) return;
            isSpinning = true;
            AudioCtrl.playTone(300, 'triangle', 0.2);

            const extraRotations = 5; 
            const randomAngle = Math.floor(Math.random() * 360);
            const totalDegree = currentRotation + (360 * extraRotations) + randomAngle;
            
            canvas.style.transform = `rotate(${totalDegree}deg)`;
            currentRotation = totalDegree;

            setTimeout(() => {
                isSpinning = false;
                const actualRotation = totalDegree % 360;
                const sliceDeg = 360 / len;
                const index = Math.floor((360 - actualRotation) % 360 / sliceDeg);
                
                this.showTask(items[index % len]);
            }, 4000); 
        };
    },

    initCards(container) {
        const grid = document.createElement('div');
        grid.id = 'card-grid';
        
        const items = [...GAME_DATA.speaking.items].sort(() => 0.5 - Math.random());
        
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-inner">
                    <div class="card-front">?</div>
                    <div class="card-back">
                        <div class="card-img-container">
                            <img class="card-img-small" src="${item.icon}" alt="ç¼©ç•¥å›¾">
                        </div>
                        <div>${item.title}</div>
                    </div>
                </div>
            `;
            card.onclick = function() {
                if (this.classList.contains('flipped')) return;
                AudioCtrl.click();
                this.classList.add('flipped');
                
                // ç­‰å¾…ç¿»è½¬åŠ¨ç”»å¤§éƒ¨åˆ†å®Œæˆåå†å¼¹å‡ºå¤§å›¾
                setTimeout(() => {
                    gameManager.showImageViewer(item);
                }, 600);
            };
            grid.appendChild(card);
        });
        
        container.appendChild(grid);
    }
};

/**
 * ç§¯åˆ†ä¸è¯„ä»·ç³»ç»Ÿ
 */
const scoreSystem = {
    tempScore: 0,
    
    setTempScore(val) {
        this.tempScore = val;
        const stars = document.querySelectorAll('.star-rating span');
        stars.forEach((s, i) => {
            if(i < val) s.classList.add('active');
            else s.classList.remove('active');
        });
        AudioCtrl.click();
    },

    submitScore() {
        if(this.tempScore === 0) this.tempScore = 1; 
        gameManager.state.score += this.tempScore;
        document.getElementById('score-display').innerText = gameManager.state.score;
        gameManager.closeModal();
        
        AudioCtrl.win();
        particleSystem.explode();
    }
};

/**
 * ç²’å­ç‰¹æ•ˆç³»ç»Ÿ
 */
const particleSystem = {
    canvas: document.getElementById('reward-overlay'),
    ctx: null,
    particles: [],
    running: false,
    
    init() {
        if (!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.ctx = this.canvas.getContext('2d');
        window.addEventListener('resize', () => {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
        });
    },

    stop() {
        this.running = false;
        this.particles = [];
        if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },

    explode() {
        if(!this.ctx) this.init();
        if(this.running) this.particles = [];
        
        for(let i=0; i<100; i++) {
            this.particles.push({
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 0.5) * 20,
                life: 1.0,
                color: `hsl(${Math.random()*360}, 100%, 50%)`,
                size: Math.random() * 5 + 2
            });
        }
        if(!this.running) this.loop();
    },

    loop() {
        if (this.particles.length === 0) {
            this.stop();
            return;
        }
        this.running = true;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        for(let i=0; i<this.particles.length; i++) {
            const p = this.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.5; // é‡åŠ›
            p.life -= 0.02;
            
            this.ctx.fillStyle = p.color;
            this.ctx.globalAlpha = Math.max(0, p.life);
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            this.ctx.fill();
        }

        this.particles = this.particles.filter(p => p.life > 0);
        
        if(this.running) {
            requestAnimationFrame(() => this.loop());
        }
    }
};

window.onload = function() {
    gameManager.init();
};

</script>
</body>
</html>
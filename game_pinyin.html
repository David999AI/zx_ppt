<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼éŸ³é—¯å…³å°å‹‡å£«</title>
    <style>
        /* ==================== åŸºç¡€æ ·å¼é‡ç½® ==================== */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #2c3e50;
        }

        /* ==================== å±‚çº§ç»“æ„ ==================== */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            overflow: hidden;
        }

        .cloud {
            position: absolute;
            background: #fff;
            border-radius: 50px;
            opacity: 0.8;
            animation: floatCloud 20s linear infinite;
        }
        .cloud::after, .cloud::before {
            content: '';
            position: absolute;
            background: #fff;
            border-radius: 50%;
        }
        .cloud::after { width: 50px; height: 50px; top: -25px; left: 25px; }
        .cloud::before { width: 40px; height: 40px; top: -15px; left: 10px; }
        
        @keyframes floatCloud {
            from { transform: translateX(100vw); }
            to { transform: translateX(-200px); }
        }

        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* å…³é”®ï¼šå…è®¸ç‚¹å‡»ç©¿é€åˆ°Canvas */
        }

        .ui-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* å­å…ƒç´ æ¢å¤ç‚¹å‡» */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
            transition: opacity 0.3s;
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        .btn {
            background: #FF9800;
            color: white;
            border: 4px solid #F57C00;
            border-radius: 20px;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px #bf360c;
            transition: transform 0.1s;
            margin: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #bf360c;
        }
        .btn-green {
            background: #4CAF50;
            border-color: #388E3C;
            box-shadow: 0 6px #1b5e20;
        }
        .btn-green:active {
            box-shadow: 0 2px #1b5e20;
        }

        h1 {
            font-size: 48px;
            color: #fff;
            text-shadow: 3px 3px 0 #3F51B5, -1px -1px 0 #3F51B5, 1px -1px 0 #3F51B5, -1px 1px 0 #3F51B5, 1px 1px 0 #3F51B5;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
            text-align: center;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        .hud-item {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            pointer-events: auto;
        }
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 10px;
            border: 2px solid #fff;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .level-card {
            width: 80px;
            height: 80px;
            background: #E0E0E0;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            color: #757575;
            cursor: pointer;
            position: relative;
            pointer-events: auto;
        }
        .level-card.unlocked {
            background: #FFC107;
            color: #fff;
            border: 3px solid #FFA000;
        }
        .level-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .stars-display {
            position: absolute;
            bottom: -5px;
            font-size: 12px;
            display: flex;
            color: #FFD700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }

        #result-modal {
            background: white;
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border: 5px solid #FFEB3B;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .big-stars {
            font-size: 60px;
            margin: 20px 0;
            color: #FFD700;
        }
    </style>
    
    <!-- ä¸¥æ ¼ä½¿ç”¨ cdn.jsdelivr.net -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.3.2/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

</head>
<body>

    <!-- èƒŒæ™¯å±‚ -->
    <div id="background">
        <div class="cloud" style="top: 10%; width: 120px; height: 40px; left: -120px; animation-delay: 0s;"></div>
        <div class="cloud" style="top: 25%; width: 180px; height: 60px; animation-duration: 25s; left: -180px; animation-delay: -5s;"></div>
        <div class="cloud" style="top: 50%; width: 100px; height: 35px; animation-duration: 18s; left: -100px; animation-delay: -10s;"></div>
    </div>

    <!-- æ¸¸æˆ Canvas -->
    <canvas id="game-stage"></canvas>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        
        <!-- 1. å¼€å§‹ç•Œé¢ -->
        <div id="start-screen" class="ui-screen">
            <h1>æ‹¼éŸ³é—¯å…³å°å‹‡å£«</h1>
            <button class="btn btn-green" onclick="startGameFlow()">å¼€å§‹å†’é™©</button>
            <div style="margin-top:20px; color:white; font-size:14px;">å»ºè®®æ¨ªå±æ¸¸ç© â€¢ å¼€å¯å£°éŸ³</div>
        </div>

        <!-- 2. å…³å¡é€‰æ‹©ç•Œé¢ -->
        <div id="level-select-screen" class="ui-screen hidden">
            <h2 style="color:white; margin-bottom:20px; font-size: 30px;">é€‰æ‹©å…³å¡</h2>
            <div class="level-grid" id="level-grid-container">
                <!-- ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="btn" onclick="gameApp.showStartScreen()" style="margin-top:20px; padding: 10px 20px; font-size: 18px;">è¿”å›</button>
        </div>

        <!-- 3. æ¸¸æˆå†…HUD -->
        <div id="hud" class="hidden">
            <div class="hud-item">
                <span>ğŸŒŸ</span>
                <span id="score-display" style="margin-left: 5px;">0</span>
            </div>
            <div class="hud-item">
                è¿›åº¦: 
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
            <button class="hud-item" style="background: #e53935; cursor: pointer; border:none;" onclick="gameApp.exitLevel()">é€€å‡º</button>
        </div>

        <!-- 4. ç»“ç®—å¼¹çª— -->
        <div id="result-overlay" class="ui-screen hidden" style="background: rgba(0,0,0,0.7);">
            <div id="result-modal">
                <h2 id="result-title" style="color:#FF9800; font-size: 36px; margin:0;">é—¯å…³æˆåŠŸ!</h2>
                <div class="big-stars" id="result-stars">â­â­â­</div>
                <p id="result-msg" style="color:#666; font-size:18px;">ä½ çœŸæ˜¯ä¸ªæ‹¼éŸ³å°å¤©æ‰ï¼</p>
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button class="btn" onclick="gameApp.showLevelSelect()">è¿”å›åœ°å›¾</button>
                    <button id="next-level-btn" class="btn btn-green" onclick="gameApp.nextLevel()">ä¸‹ä¸€å…³</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€å˜é‡å®šä¹‰
        let gameApp = null;

        // å…¨å±€å…¥å£ï¼šç¡®ä¿ DOM ç‚¹å‡»èƒ½è§¦å‘
        function startGameFlow() {
            // å¦‚æœå°šæœªåˆå§‹åŒ–ï¼Œåˆ™ç«‹å³åˆå§‹åŒ–
            if (!gameApp) {
                gameApp = new GameApp();
            }
            
            if (gameApp) {
                gameApp.initAudioContext();
                gameApp.showLevelSelect();
            }
        }

        const GAME_CONFIG = {
            designWidth: 1024,
            designHeight: 768,
            colors: {
                primary: 0xFF9800,
                success: 0x4CAF50,
                error: 0xF44336,
                text: 0x333333,
                cardBg: 0xFFFFFF
            }
        };

        const LEVELS = [
            {
                id: 1,
                title: "å£°æ¯åˆè¯†",
                type: "identify",
                content: [
                    { audio: "b", target: "b", options: ["b", "d", "p", "q"] },
                    { audio: "m", target: "m", options: ["m", "n", "w", "u"] },
                    { audio: "f", target: "f", options: ["f", "t", "l", "b"] }
                ]
            },
            {
                id: 2,
                title: "å•éŸµæ¯è¿çº¿",
                type: "match",
                content: [
                    { targetChar: "a", total: 3 },
                    { targetChar: "o", total: 3 }
                ]
            },
            {
                id: 3,
                title: "æ‹¼è¯»æŒ‘æˆ˜",
                type: "spell_choice",
                content: [
                    { target: "ba", options: ["b-a", "p-a", "d-a"], display: "çˆ¸" },
                    { target: "ma", options: ["m-a", "n-a", "b-a"], display: "å¦ˆ" },
                    { target: "po", options: ["p-o", "b-o", "m-o"], display: "å©†" }
                ]
            }
        ];

        let userProfile = {
            unlockedLevels: 1,
            levelStars: {}
        };

        // æçŸ­çš„é™éŸ³ WAV Base64
        const SILENT_AUDIO = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABgdZGF0YQQAAAAAAA==';

        const audioController = {
            sounds: {},
            init: function() {
                try {
                    this.sounds.correct = new Howl({ src: [SILENT_AUDIO], volume: 0.5 });
                    this.sounds.wrong = new Howl({ src: [SILENT_AUDIO], volume: 0.5 });
                    this.sounds.bgm = new Howl({ src: [SILENT_AUDIO], loop: true, volume: 0.2 });
                } catch (e) {
                    console.warn("Audio init failed:", e);
                }
            },
            play: function(key) {
                // é€»è¾‘å ä½ï¼šå®é™…é¡¹ç›®åº”æ›¿æ¢ä¸ºçœŸå®éŸ³æ•ˆè·¯å¾„
                if (key === 'correct' || key === 'wrong') {
                     if (this.sounds[key]) this.sounds[key].play();
                } else if (key && key.length <= 5) {
                    this.speak(key);
                }
            },
            speak: function(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                }
            }
        };

        class GameApp {
            constructor() {
                this.app = null;
                this.currentLevelId = 0;
                this.currentLevelData = null;
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.correctCount = 0;
                this.isProcessing = false; 
                
                this.elements = {
                    startScreen: document.getElementById('start-screen'),
                    levelSelectScreen: document.getElementById('level-select-screen'),
                    hud: document.getElementById('hud'),
                    resultOverlay: document.getElementById('result-overlay'),
                    scoreDisplay: document.getElementById('score-display'),
                    progressFill: document.getElementById('progress-fill'),
                    gameCanvas: document.getElementById('game-stage')
                };

                this.resize = this.resize.bind(this);
                this.initPixi();
                audioController.init();
            }

            initAudioContext() {
                if (window.Howler && Howler.ctx && Howler.ctx.state !== 'running') {
                    Howler.ctx.resume();
                }
            }

            initPixi() {
                if (typeof PIXI === 'undefined') {
                    console.error('PIXI.js failed to load');
                    return;
                }

                this.app = new PIXI.Application({
                    view: this.elements.gameCanvas,
                    width: GAME_CONFIG.designWidth,
                    height: GAME_CONFIG.designHeight,
                    backgroundAlpha: 0,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                this.resize();
                window.addEventListener('resize', this.resize);
            }

            resize() {
                if (!this.app || !this.app.view) return;
                
                const w = window.innerWidth;
                const h = window.innerHeight;
                const scale = Math.min(w / GAME_CONFIG.designWidth, h / GAME_CONFIG.designHeight);
                
                const newWidth = GAME_CONFIG.designWidth * scale;
                const newHeight = GAME_CONFIG.designHeight * scale;
                
                this.app.view.style.width = newWidth + 'px';
                this.app.view.style.height = newHeight + 'px';
            }

            hideAllScreens() {
                const screens = [
                    this.elements.startScreen, 
                    this.elements.levelSelectScreen, 
                    this.elements.hud, 
                    this.elements.resultOverlay
                ];
                screens.forEach(el => el.classList.add('hidden'));
            }

            clearStage() {
                if(this.app && this.app.stage) {
                    // æ¸…ç†æ‰€æœ‰å¯èƒ½æ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»ï¼Œé˜²æ­¢æŠ¥é”™
                    gsap.killTweensOf(this.app.stage.children);
                    this.app.stage.removeChildren();
                }
            }

            showStartScreen() {
                this.hideAllScreens();
                this.elements.startScreen.classList.remove('hidden');
                this.clearStage();
            }

            showLevelSelect() {
                this.hideAllScreens();
                this.elements.levelSelectScreen.classList.remove('hidden');
                this.renderLevelGrid();
                this.clearStage();
            }

            renderLevelGrid() {
                const container = document.getElementById('level-grid-container');
                container.innerHTML = '';
                
                LEVELS.forEach(level => {
                    const isUnlocked = level.id <= userProfile.unlockedLevels;
                    const card = document.createElement('div');
                    card.className = `level-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                    card.textContent = `${level.id}`;
                    
                    if (isUnlocked) {
                        const stars = userProfile.levelStars[level.id] || 0;
                        let starStr = '';
                        for(let i=0; i<3; i++) starStr += (i < stars ? 'â­' : 'â˜†');
                        
                        const starDiv = document.createElement('div');
                        starDiv.className = 'stars-display';
                        starDiv.textContent = starStr;
                        card.appendChild(starDiv);
                        card.onclick = () => this.startLevel(level.id);
                    }
                    container.appendChild(card);
                });
            }

            startLevel(levelId) {
                this.currentLevelId = levelId;
                this.currentLevelData = LEVELS.find(l => l.id === levelId);
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.correctCount = 0;
                this.isProcessing = false;

                this.hideAllScreens();
                this.elements.hud.classList.remove('hidden');
                
                this.updateHUD();
                this.loadQuestion();
            }

            updateHUD() {
                this.elements.scoreDisplay.textContent = this.score;
                const total = this.currentLevelData.content.length || 1;
                const progress = (this.currentQuestionIndex / total) * 100;
                this.elements.progressFill.style.width = `${progress}%`;
            }

            loadQuestion() {
                if(!this.app || !this.app.stage) return;
                
                this.clearStage();
                this.isProcessing = false;
                this.app.stage.eventMode = 'auto'; // æ¢å¤äº¤äº’

                if (this.currentQuestionIndex >= this.currentLevelData.content.length) {
                    this.finishLevel();
                    return;
                }

                this.updateHUD();
                
                const questionData = this.currentLevelData.content[this.currentQuestionIndex];
                const levelType = this.currentLevelData.type;

                if (levelType === 'identify') this.renderIdentifyLevel(questionData);
                else if (levelType === 'match') this.renderMatchLevel(questionData);
                else if (levelType === 'spell_choice') this.renderSpellLevel(questionData);
            }

            // ç©æ³•1: å¬éŸ³é€‰å­—
            renderIdentifyLevel(data) {
                const playBtn = this.createButton("ğŸ”Š ç‚¹å‡»å¬éŸ³", 512, 150, 0x2196F3);
                playBtn.on('pointerdown', () => {
                    audioController.play(data.audio);
                    gsap.to(playBtn.scale, {x: 1.1, y: 1.1, duration: 0.1, yoyo: true, repeat: 1});
                });
                this.app.stage.addChild(playBtn);
                
                // å»¶è¿Ÿæ’­æ”¾
                setTimeout(() => {
                    if (this.currentLevelData && this.currentLevelData.type === 'identify') {
                        audioController.play(data.audio);
                    }
                }, 500);

                const options = data.options;
                const gap = 200;
                const totalWidth = (options.length - 1) * gap;
                
                options.forEach((opt, index) => {
                    const offsetX = 512 - totalWidth / 2;
                    const card = this.createCard(opt, offsetX + index * gap, 400);
                    
                    card.on('pointerdown', () => {
                        if (this.isProcessing) return;
                        if (opt === data.target) this.handleAnswer(true, card);
                        else this.handleAnswer(false, card);
                    });
                    this.app.stage.addChild(card);
                });

                const text = new PIXI.Text("è¯·é€‰å‡ºå¬åˆ°çš„å£°æ¯", {fontSize: 36, fill: 0xffffff, fontWeight: 'bold'});
                text.anchor.set(0.5);
                text.position.set(512, 600);
                this.app.stage.addChild(text);
            }

            // ç©æ³•2: ç‚¹å‡»æ¶ˆé™¤
            renderMatchLevel(data) {
                const targetChar = data.targetChar;
                const totalCorrect = data.total;
                
                const text = new PIXI.Text(`è¯·ç‚¹å‡»æ‰€æœ‰çš„å•éŸµæ¯ '${targetChar}'`, {fontSize: 36, fill: 0xffffff});
                text.anchor.set(0.5);
                text.position.set(512, 100);
                this.app.stage.addChild(text);

                const chars = ['a','o','e','i','u','Ã¼'];
                const bubblesData = [];
                for(let i=0; i<totalCorrect; i++) bubblesData.push({val: targetChar, correct: true});
                for(let i=0; i<3; i++) {
                    const wrong = chars.filter(c => c !== targetChar)[Math.floor(Math.random()*5)] || 'x';
                    bubblesData.push({val: wrong, correct: false});
                }
                
                const positions = [
                    {x:200, y:300}, {x:400, y:500}, {x:600, y:250}, 
                    {x:800, y:400}, {x:500, y:600}, {x:300, y:650}
                ];

                let foundCount = 0;
                // ä¿å­˜å½“å‰é¢˜ç›®ç´¢å¼•å¼•ç”¨ï¼Œé˜²æ­¢å¿«é€Ÿåˆ‡æ¢å¯¼è‡´å›è°ƒé”™è¯¯
                const currentQIndex = this.currentQuestionIndex;

                bubblesData.forEach((b, i) => {
                    if(i >= positions.length) return;
                    
                    const bubble = new PIXI.Container();
                    bubble.position.set(positions[i].x, positions[i].y);
                    
                    const circle = new PIXI.Graphics();
                    circle.beginFill(0xFFFFFF);
                    circle.lineStyle(4, 0x2196F3);
                    circle.drawCircle(0, 0, 50);
                    circle.endFill();
                    
                    const label = new PIXI.Text(b.val, {fontSize: 40, fill: 0x333});
                    label.anchor.set(0.5);
                    
                    bubble.addChild(circle, label);
                    bubble.eventMode = 'static';
                    bubble.cursor = 'pointer';

                    bubble.on('pointerdown', () => {
                        if(this.currentQuestionIndex !== currentQIndex) return; // é¢˜ç›®å·²è¿‡

                        bubble.eventMode = 'none'; // é˜²æ­¢é‡å¤ç‚¹å‡»
                        if (b.correct) {
                            circle.tint = GAME_CONFIG.colors.success;
                            audioController.play(b.val);
                            gsap.to(bubble.scale, {x: 0, y: 0, duration: 0.5, delay: 0.2});
                            
                            foundCount++;
                            this.score += 10;
                            this.elements.scoreDisplay.textContent = this.score;
                            
                            if (foundCount >= totalCorrect) {
                                this.correctCount++;
                                setTimeout(() => {
                                    if(this.currentQuestionIndex === currentQIndex) this.nextQuestion();
                                }, 1000);
                            }
                        } else {
                            audioController.play('wrong');
                            circle.tint = GAME_CONFIG.colors.error;
                            gsap.to(bubble, {x: bubble.x + 10, duration: 0.05, yoyo: true, repeat: 3, onComplete: () => {
                                gsap.to(bubble, {alpha: 0, duration: 0.5});
                            }});
                        }
                    });

                    this.app.stage.addChild(bubble);
                    gsap.to(bubble, {y: positions[i].y - 20, duration: 2 + Math.random(), yoyo: true, repeat: -1, ease: "sine.inOut"});
                });
            }

            // ç©æ³•3: æ‹¼è¯»
            renderSpellLevel(data) {
                const wordBg = new PIXI.Graphics();
                wordBg.beginFill(0xFFFFFF);
                wordBg.drawRoundedRect(-60, -60, 120, 120, 20);
                wordBg.endFill();
                wordBg.position.set(512, 200);
                
                const wordText = new PIXI.Text(data.display, {fontSize: 80, fill: 0x333});
                wordText.anchor.set(0.5);
                wordBg.addChild(wordText);
                this.app.stage.addChild(wordBg);

                const startY = 400;
                data.options.forEach((opt, index) => {
                    const btn = this.createButton(opt, 512, startY + index * 100, 0xFFCC80, 200, 70);
                    btn.on('pointerdown', () => {
                        if (this.isProcessing) return;
                        if (opt.replace("-", "") === data.target) this.handleAnswer(true, btn);
                        else this.handleAnswer(false, btn);
                    });
                    this.app.stage.addChild(btn);
                });
            }

            createCard(textStr, x, y) {
                const container = new PIXI.Container();
                container.position.set(x, y);
                
                const bg = new PIXI.Graphics();
                bg.beginFill(GAME_CONFIG.colors.cardBg);
                bg.lineStyle(4, 0xCCCCCC);
                bg.drawRoundedRect(-60, -80, 120, 160, 15);
                bg.endFill();
                
                container._customBg = bg;

                const shadow = new PIXI.Graphics();
                shadow.beginFill(0x000000, 0.2);
                shadow.drawRoundedRect(-55, -75, 120, 160, 15);
                shadow.endFill();
                
                container.addChild(shadow); 
                container.addChild(bg);

                const text = new PIXI.Text(textStr, {
                    fontSize: 60,
                    fill: GAME_CONFIG.colors.text,
                    fontFamily: "Arial"
                });
                text.anchor.set(0.5);
                container.addChild(text);

                container.eventMode = 'static'; // v7 å…¼å®¹å†™æ³•
                container.cursor = 'pointer';
                container.on('pointerover', () => { if(bg) bg.tint = 0xFFF9C4; });
                container.on('pointerout', () => { if(bg) bg.tint = 0xFFFFFF; });

                return container;
            }

            createButton(label, x, y, color, w=200, h=60) {
                const container = new PIXI.Container();
                container.position.set(x, y);

                const bg = new PIXI.Graphics();
                bg.beginFill(color);
                bg.drawRoundedRect(-w/2, -h/2, w, h, h/2);
                bg.endFill();
                
                container._customBg = bg;
                
                const text = new PIXI.Text(label, {fontSize: 28, fill: 0xFFFFFF, fontWeight: 'bold'});
                text.anchor.set(0.5);
                
                container.addChild(bg, text);
                container.eventMode = 'static';
                container.cursor = 'pointer';
                return container;
            }

            handleAnswer(isCorrect, targetObj) {
                this.isProcessing = true;
                // æš‚æ—¶ç¦ç”¨èˆå°äº¤äº’ï¼Œé˜²æ­¢å¿«é€Ÿå¤šç‚¹
                this.app.stage.eventMode = 'none';
                
                const bg = targetObj._customBg || targetObj.children[0]; 

                if (isCorrect) {
                    if(bg) bg.tint = GAME_CONFIG.colors.success;
                    gsap.to(targetObj.scale, {x: 1.2, y: 1.2, duration: 0.3, ease: "back.out(1.7)"});
                    
                    audioController.play('correct');
                    this.score += 20;
                    this.correctCount++;

                    setTimeout(() => {
                        this.nextQuestion();
                    }, 1000);

                } else {
                    const originalTint = bg ? bg.tint : 0xFFFFFF;
                    if(bg) bg.tint = GAME_CONFIG.colors.error;
                    audioController.play('wrong');

                    gsap.to(targetObj, {x: targetObj.x + 10, duration: 0.05, yoyo: true, repeat: 5, onComplete: () => {
                        if(bg) bg.tint = originalTint;
                        this.isProcessing = false;
                        if(this.app && this.app.stage) this.app.stage.eventMode = 'auto'; // æ¢å¤äº¤äº’
                    }});
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.loadQuestion();
            }

            finishLevel() {
                this.hideAllScreens();
                this.elements.resultOverlay.classList.remove('hidden');
                
                let accuracy = 0;
                if (this.currentLevelData.content.length > 0) {
                     accuracy = this.correctCount / this.currentLevelData.content.length;
                }
                
                let stars = 1;
                if (accuracy > 0.6) stars = 2;
                if (accuracy > 0.9) stars = 3;

                const starStr = "â­".repeat(stars);
                document.getElementById('result-stars').textContent = starStr;
                
                let msg = "è¿˜éœ€åŠªåŠ›å“¦ï¼";
                if (stars === 2) msg = "çœŸæ£’ï¼Œç»§ç»­åŠ æ²¹ï¼";
                if (stars === 3) msg = "å¤ªå‰å®³äº†ï¼Œæ‹¼éŸ³å°çŠ¶å…ƒï¼";
                document.getElementById('result-msg').textContent = msg;

                userProfile.levelStars[this.currentLevelId] = Math.max(userProfile.levelStars[this.currentLevelId] || 0, stars);
                if (stars >= 1 && this.currentLevelId === userProfile.unlockedLevels) {
                    userProfile.unlockedLevels++;
                }

                const nextBtn = document.getElementById('next-level-btn');
                if (this.currentLevelId >= LEVELS.length) {
                    nextBtn.style.display = 'none';
                } else {
                    nextBtn.style.display = 'block';
                }
            }

            nextLevel() {
                if (this.currentLevelId < LEVELS.length) {
                    this.startLevel(this.currentLevelId + 1);
                } else {
                    this.showLevelSelect();
                }
            }

            exitLevel() {
                this.showLevelSelect();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå®ä¾‹åŒ–
        window.onload = () => {
            if (!gameApp) {
                gameApp = new GameApp();
            }
        };

    </script>
</body>
</html>
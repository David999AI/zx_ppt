<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼éŸ³é—¯å…³å°å‹‡å£« - ä¸€å¹´çº§å…¨è¦†ç›–ç‰ˆ</title>
    <style>
        /* ==================== åŸºç¡€æ ·å¼é‡ç½® ==================== */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #2c3e50;
        }

        /* ==================== å±‚çº§ç»“æ„ ==================== */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            overflow: hidden;
        }

        .cloud {
            position: absolute;
            background: #fff;
            border-radius: 50px;
            opacity: 0.8;
            animation: floatCloud 20s linear infinite;
        }
        .cloud::after, .cloud::before {
            content: '';
            position: absolute;
            background: #fff;
            border-radius: 50%;
        }
        .cloud::after { width: 50px; height: 50px; top: -25px; left: 25px; }
        .cloud::before { width: 40px; height: 40px; top: -15px; left: 10px; }
        
        @keyframes floatCloud {
            from { transform: translateX(100vw); }
            to { transform: translateX(-200px); }
        }

        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* å…³é”®ï¼šå…è®¸ç‚¹å‡»ç©¿é€åˆ°Canvas */
        }

        .ui-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* å­å…ƒç´ æ¢å¤ç‚¹å‡» */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
            transition: opacity 0.3s;
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        .btn {
            background: #FF9800;
            color: white;
            border: 4px solid #F57C00;
            border-radius: 20px;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px #bf360c;
            transition: transform 0.1s;
            margin: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #bf360c;
        }
        .btn-green {
            background: #4CAF50;
            border-color: #388E3C;
            box-shadow: 0 6px #1b5e20;
        }
        .btn-green:active {
            box-shadow: 0 2px #1b5e20;
        }

        h1 {
            font-size: 48px;
            color: #fff;
            text-shadow: 3px 3px 0 #3F51B5, -1px -1px 0 #3F51B5, 1px -1px 0 #3F51B5, -1px 1px 0 #3F51B5, 1px 1px 0 #3F51B5;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
            text-align: center;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        .hud-item {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            pointer-events: auto;
        }
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 10px;
            border: 2px solid #fff;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .level-card {
            width: 70px;
            height: 70px;
            background: #E0E0E0;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: #757575;
            cursor: pointer;
            position: relative;
            pointer-events: auto;
        }
        /* æ‰€æœ‰å…³å¡é»˜è®¤éƒ½æ˜¯è§£é”æ ·å¼ */
        .level-card.unlocked {
            background: #FFC107;
            color: #fff;
            border: 3px solid #FFA000;
        }
        .level-title {
            font-size: 10px;
            text-align: center;
            margin-top: 2px;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .stars-display {
            position: absolute;
            bottom: -8px;
            font-size: 10px;
            display: flex;
            color: #FFD700;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            padding: 0 2px;
        }

        #result-modal {
            background: white;
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border: 5px solid #FFEB3B;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .big-stars {
            font-size: 60px;
            margin: 20px 0;
            color: #FFD700;
        }
    </style>
    
    <!-- ä¸¥æ ¼ä½¿ç”¨ cdn.jsdelivr.net -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.3.2/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>

</head>
<body>

    <!-- èƒŒæ™¯å±‚ -->
    <div id="background">
        <div class="cloud" style="top: 10%; width: 120px; height: 40px; left: -120px; animation-delay: 0s;"></div>
        <div class="cloud" style="top: 25%; width: 180px; height: 60px; animation-duration: 25s; left: -180px; animation-delay: -5s;"></div>
        <div class="cloud" style="top: 50%; width: 100px; height: 35px; animation-duration: 18s; left: -100px; animation-delay: -10s;"></div>
    </div>

    <!-- æ¸¸æˆ Canvas -->
    <canvas id="game-stage"></canvas>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        
        <!-- 1. å¼€å§‹ç•Œé¢ -->
        <div id="start-screen" class="ui-screen">
            <h1>æ‹¼éŸ³é—¯å…³å°å‹‡å£«</h1>
            <h2 style="color: #FFEB3B; margin-top: -20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ä¸€å¹´çº§ä¸Šå­¦æœŸå…¨è¦†ç›–ç‰ˆ</h2>
            <button class="btn btn-green" onclick="startGameFlow()">å¼€å§‹å†’é™©</button>
            <div style="margin-top:20px; color:white; font-size:14px;">å»ºè®®æ¨ªå±æ¸¸ç© â€¢ å¼€å¯å£°éŸ³</div>
        </div>

        <!-- 2. å…³å¡é€‰æ‹©ç•Œé¢ -->
        <div id="level-select-screen" class="ui-screen hidden">
            <h2 style="color:white; margin-bottom:10px; font-size: 24px;">é€‰æ‹©å…³å¡</h2>
            <div class="level-grid" id="level-grid-container">
                <!-- ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="btn" onclick="gameApp.showStartScreen()" style="margin-top:10px; padding: 10px 20px; font-size: 18px;">è¿”å›</button>
        </div>

        <!-- 3. æ¸¸æˆå†…HUD -->
        <div id="hud" class="hidden">
            <div class="hud-item">
                <span>ğŸŒŸ</span>
                <span id="score-display" style="margin-left: 5px;">0</span>
            </div>
            <div class="hud-item">
                è¿›åº¦: 
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
            <button class="hud-item" style="background: #e53935; cursor: pointer; border:none;" onclick="gameApp.exitLevel()">é€€å‡º</button>
        </div>

        <!-- 4. ç»“ç®—å¼¹çª— -->
        <div id="result-overlay" class="ui-screen hidden" style="background: rgba(0,0,0,0.7);">
            <div id="result-modal">
                <h2 id="result-title" style="color:#FF9800; font-size: 36px; margin:0;">é—¯å…³æˆåŠŸ!</h2>
                <div class="big-stars" id="result-stars">â­â­â­</div>
                <p id="result-msg" style="color:#666; font-size:18px;">ä½ çœŸæ˜¯ä¸ªæ‹¼éŸ³å°å¤©æ‰ï¼</p>
                <div style="display:flex; justify-content:center; gap:10px;">
                    <button class="btn" onclick="gameApp.showLevelSelect()">è¿”å›åœ°å›¾</button>
                    <button id="next-level-btn" class="btn btn-green" onclick="gameApp.nextLevel()">ä¸‹ä¸€å…³</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€å˜é‡å®šä¹‰
        let gameApp = null;

        // å·¥å…·å‡½æ•°ï¼šæ•°ç»„æ´—ç‰Œ
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // å…¨å±€å…¥å£ï¼šç¡®ä¿ DOM ç‚¹å‡»èƒ½è§¦å‘
        function startGameFlow() {
            // å¦‚æœå°šæœªåˆå§‹åŒ–ï¼Œåˆ™ç«‹å³åˆå§‹åŒ–
            if (!gameApp) {
                gameApp = new GameApp();
            }
            
            if (gameApp) {
                gameApp.initAudioContext();
                gameApp.showLevelSelect();
            }
        }

        const GAME_CONFIG = {
            designWidth: 1024,
            designHeight: 768,
            colors: {
                primary: 0xFF9800,
                success: 0x4CAF50,
                error: 0xF44336,
                text: 0x333333,
                cardBg: 0xFFFFFF
            }
        };

        // ä¸€å¹´çº§ä¸Šå­¦æœŸæ‹¼éŸ³å…¨è¦†ç›–é¢˜åº“
        const LEVELS = [
            // ç¬¬ä¸€éƒ¨åˆ†ï¼šå£°æ¯åŸºç¡€ (23ä¸ªå£°æ¯)
            {
                id: 1, title: "å£°æ¯ b p m f", type: "identify",
                content: [
                    { audio: "b", target: "b", options: ["b", "d", "p", "q"] },
                    { audio: "p", target: "p", options: ["p", "b", "q", "d"] },
                    { audio: "m", target: "m", options: ["m", "n", "w", "u"] },
                    { audio: "f", target: "f", options: ["f", "t", "l", "b"] }
                ]
            },
            {
                id: 2, title: "å£°æ¯ d t n l", type: "identify",
                content: [
                    { audio: "d", target: "d", options: ["d", "b", "p", "q"] },
                    { audio: "t", target: "t", options: ["t", "f", "l", "k"] },
                    { audio: "n", target: "n", options: ["n", "m", "h", "u"] },
                    { audio: "l", target: "l", options: ["l", "i", "t", "f"] }
                ]
            },
            {
                id: 3, title: "å£°æ¯ g k h", type: "identify",
                content: [
                    { audio: "g", target: "g", options: ["g", "q", "d", "a"] },
                    { audio: "k", target: "k", options: ["k", "h", "t", "x"] },
                    { audio: "h", target: "h", options: ["h", "n", "m", "k"] }
                ]
            },
            {
                id: 4, title: "å£°æ¯ j q x", type: "identify",
                content: [
                    { audio: "j", target: "j", options: ["j", "i", "g", "y"] },
                    { audio: "q", target: "q", options: ["q", "p", "g", "b"] },
                    { audio: "x", target: "x", options: ["x", "k", "h", "s"] }
                ]
            },
            {
                id: 5, title: "å£°æ¯ zh ch sh r", type: "identify",
                content: [
                    { audio: "zh", target: "zh", options: ["zh", "z", "ch", "sh"] },
                    { audio: "ch", target: "ch", options: ["ch", "c", "zh", "sh"] },
                    { audio: "sh", target: "sh", options: ["sh", "s", "ch", "r"] },
                    { audio: "r", target: "r", options: ["r", "y", "i", "l"] }
                ]
            },
            {
                id: 6, title: "å£°æ¯ z c s", type: "match",
                content: [
                    { targetChar: "z", total: 3 },
                    { targetChar: "c", total: 3 },
                    { targetChar: "s", total: 3 }
                ]
            },
            {
                id: 7, title: "å£°æ¯ y w", type: "identify",
                content: [
                    { audio: "y", target: "y", options: ["y", "i", "u", "v"] },
                    { audio: "w", target: "w", options: ["w", "u", "m", "n"] }
                ]
            },

            // ç¬¬äºŒéƒ¨åˆ†ï¼šéŸµæ¯åŸºç¡€ (24ä¸ªéŸµæ¯)
            {
                id: 8, title: "å•éŸµæ¯ a o e", type: "identify",
                content: [
                    { audio: "a", target: "a", options: ["a", "o", "e", "u"] },
                    { audio: "o", target: "o", options: ["o", "a", "e", "i"] },
                    { audio: "e", target: "e", options: ["e", "o", "a", "u"] }
                ]
            },
            {
                id: 9, title: "å•éŸµæ¯ i u Ã¼", type: "identify",
                content: [
                    { audio: "i", target: "i", options: ["i", "l", "j", "y"] },
                    { audio: "u", target: "u", options: ["u", "Ã¼", "w", "o"] },
                    { audio: "Ã¼", target: "Ã¼", options: ["Ã¼", "u", "v", "i"] }
                ]
            },
            {
                id: 10, title: "å¤éŸµæ¯ ai ei ui", type: "match",
                content: [
                    { targetChar: "ai", total: 3 },
                    { targetChar: "ei", total: 3 },
                    { targetChar: "ui", total: 3 }
                ]
            },
            {
                id: 11, title: "å¤éŸµæ¯ ao ou iu", type: "match",
                content: [
                    { targetChar: "ao", total: 3 },
                    { targetChar: "ou", total: 3 },
                    { targetChar: "iu", total: 3 }
                ]
            },
            {
                id: 12, title: "å¤éŸµæ¯ ie Ã¼e er", type: "identify",
                content: [
                    { audio: "ie", target: "ie", options: ["ie", "ei", "er", "ye"] },
                    { audio: "Ã¼e", target: "Ã¼e", options: ["Ã¼e", "ue", "un", "vn"] },
                    { audio: "er", target: "er", options: ["er", "re", "en", "ai"] }
                ]
            },
            {
                id: 13, title: "å‰é¼»éŸµæ¯ an en in", type: "identify",
                content: [
                    { audio: "an", target: "an", options: ["an", "ang", "ai", "ao"] },
                    { audio: "en", target: "en", options: ["en", "eng", "ei", "er"] },
                    { audio: "in", target: "in", options: ["in", "ing", "ie", "iu"] }
                ]
            },
            {
                id: 14, title: "å‰é¼»éŸµæ¯ un Ã¼n", type: "identify",
                content: [
                    { audio: "un", target: "un", options: ["un", "vn", "ui", "ue"] },
                    { audio: "Ã¼n", target: "Ã¼n", options: ["Ã¼n", "un", "in", "iu"] }
                ]
            },
            {
                id: 15, title: "åé¼»éŸµæ¯ ang eng ing ong", type: "match",
                content: [
                    { targetChar: "ang", total: 2 },
                    { targetChar: "eng", total: 2 },
                    { targetChar: "ing", total: 2 },
                    { targetChar: "ong", total: 2 }
                ]
            },

            // ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•´ä½“è®¤è¯»éŸ³èŠ‚ (16ä¸ª)
            {
                id: 16, title: "æ•´ä½“è®¤è¯» zhi chi shi ri", type: "identify",
                content: [
                    { audio: "zhi", target: "zhi", options: ["zhi", "zi", "z", "zh"] },
                    { audio: "chi", target: "chi", options: ["chi", "ci", "c", "ch"] },
                    { audio: "shi", target: "shi", options: ["shi", "si", "s", "sh"] },
                    { audio: "ri", target: "ri", options: ["ri", "r", "i", "ji"] }
                ]
            },
            {
                id: 17, title: "æ•´ä½“è®¤è¯» zi ci si", type: "match",
                content: [
                    { targetChar: "zi", total: 3 },
                    { targetChar: "ci", total: 3 },
                    { targetChar: "si", total: 3 }
                ]
            },
            {
                id: 18, title: "æ•´ä½“è®¤è¯» yi wu yu", type: "identify",
                content: [
                    { audio: "yi", target: "yi", options: ["yi", "y", "i", "yin"] },
                    { audio: "wu", target: "wu", options: ["wu", "w", "u", "un"] },
                    { audio: "yu", target: "yu", options: ["yu", "y", "Ã¼", "yun"] }
                ]
            },
            {
                id: 19, title: "æ•´ä½“è®¤è¯» ye yue yuan", type: "match",
                content: [
                    { targetChar: "ye", total: 2 },
                    { targetChar: "yue", total: 2 },
                    { targetChar: "yuan", total: 2 }
                ]
            },
            {
                id: 20, title: "æ•´ä½“è®¤è¯» yin yun ying", type: "identify",
                content: [
                    { audio: "yin", target: "yin", options: ["yin", "yi", "in", "ing"] },
                    { audio: "yun", target: "yun", options: ["yun", "yu", "un", "vn"] },
                    { audio: "ying", target: "ying", options: ["ying", "yi", "in", "ing"] }
                ]
            },

            // ç¬¬å››éƒ¨åˆ†ï¼šæ ¸å¿ƒè§„åˆ™ä¸æ‹¼è¯»åº”ç”¨
            {
                id: 21, title: "æ ‡è°ƒè§„åˆ™", type: "spell_choice",
                content: [
                    { target: "gui", options: ["guÄ«", "guÃ­", "guÇ", "guÃ¬"], display: "gui (æ ‡è°ƒåœ¨è°?)" }, // å®é™…åº”ä¸º i 
                    { target: "ui", options: ["iuå¹¶åˆ—æ ‡åœ¨å", "iuå¹¶åˆ—æ ‡åœ¨å‰"], display: "iuæ ‡è°ƒå£è¯€" },
                    { target: "lei", options: ["l-ei", "l-ie"], display: "ç´¯(lei)" },
                ]
            },
            {
                id: 22, title: "Ã¼ å»ç‚¹è§„åˆ™", type: "identify",
                content: [
                    { audio: "ju", target: "ju", options: ["ju", "jÃ¼", "jv", "qv"] },
                    { audio: "qu", target: "qu", options: ["qu", "qÃ¼", "qv", "xu"] },
                    { audio: "xu", target: "xu", options: ["xu", "xÃ¼", "xi", "xiu"] }
                ]
            },
            {
                id: 23, title: "ä¸‰æ‹¼éŸ³èŠ‚æŒ‘æˆ˜", type: "spell_choice",
                content: [
                    { target: "gua", options: ["g-u-a", "g-a", "gu-a"], display: "ç“œ(gua)" },
                    { target: "hua", options: ["h-u-a", "h-a", "hu-a"], display: "èŠ±(hua)" },
                    { target: "xiong", options: ["x-i-ong", "x-ong", "xi-ong"], display: "ç†Š(xiong)" }
                ]
            },
            {
                id: 24, title: "å››å£°è°ƒå¤§æŒ‘æˆ˜", type: "spell_choice",
                content: [
                    { target: "ma1", options: ["mÄ", "mÃ¡", "mÇ", "mÃ "], display: "å¦ˆ(ä¸€å£°)" },
                    { target: "ma2", options: ["mÄ", "mÃ¡", "mÇ", "mÃ "], display: "éº»(äºŒå£°)" },
                    { target: "ma3", options: ["mÄ", "mÃ¡", "mÇ", "mÃ "], display: "é©¬(ä¸‰å£°)" },
                    { target: "ma4", options: ["mÄ", "mÃ¡", "mÇ", "mÃ "], display: "éª‚(å››å£°)" }
                ]
            }
        ];

        let userProfile = {
            // unlockedLevels: 1, // ç§»é™¤å…³å¡é”å®šé€»è¾‘
            levelStars: {}
        };

        // æçŸ­çš„é™éŸ³ WAV Base64
        const SILENT_AUDIO = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABgdZGF0YQQAAAAAAA==';

        const audioController = {
            sounds: {},
            init: function() {
                try {
                    this.sounds.correct = new Howl({ src: [SILENT_AUDIO], volume: 0.5 });
                    this.sounds.wrong = new Howl({ src: [SILENT_AUDIO], volume: 0.5 });
                } catch (e) {
                    console.warn("Audio init failed:", e);
                }
            },
            play: function(key) {
                // é€»è¾‘å ä½ï¼šå®é™…é¡¹ç›®åº”æ›¿æ¢ä¸ºçœŸå®éŸ³æ•ˆè·¯å¾„
                // è¿™é‡Œä½¿ç”¨ Web Speech API è¿›è¡Œå…œåº•å‘éŸ³
                if (key === 'correct' || key === 'wrong') {
                     // ç®€å•æ¨¡æ‹Ÿ
                     if(key === 'wrong') this.speak("ä¸å¯¹å“¦");
                     else this.speak("æ£’");
                } else if (key) {
                    // å¤„ç†å¸¦å£°è°ƒçš„æ‹¼éŸ³å‘éŸ³ï¼Œä¾‹å¦‚ "mÄ" ä¼šè¯»ä½œ "å¦ˆ"
                    // å¯¹äºçº¯å­—æ¯ï¼Œç›´æ¥è¯»å­—æ¯
                    this.speak(key);
                }
            },
            speak: function(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    // ç®€å•çš„æ˜ å°„å¤„ç†ï¼Œè®©æœ—è¯»æ›´è‡ªç„¶
                    let speakText = text;
                    if (text === 'ju') speakText = 'å±…';
                    if (text === 'qu') speakText = 'åŒº';
                    if (text === 'xu') speakText = 'éœ€';
                    if (text === 'zi') speakText = 'èµ„';
                    if (text === 'ci') speakText = 'ç–µ';
                    if (text === 'si') speakText = 'æ€';
                    if (text === 'zhi') speakText = 'çŸ¥';
                    if (text === 'chi') speakText = 'åƒ';
                    if (text === 'shi') speakText = 'è¯—';
                    if (text === 'ri') speakText = 'æ—¥';

                    const utterance = new SpeechSynthesisUtterance(speakText);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                }
            }
        };

        class GameApp {
            constructor() {
                this.app = null;
                this.currentLevelId = 0;
                this.currentLevelData = null;
                this.currentQuestions = []; // å­˜å‚¨å½“å‰å…³å¡éšæœºåŒ–åçš„é¢˜ç›®
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.correctCount = 0;
                this.isProcessing = false; 
                
                this.elements = {
                    startScreen: document.getElementById('start-screen'),
                    levelSelectScreen: document.getElementById('level-select-screen'),
                    hud: document.getElementById('hud'),
                    resultOverlay: document.getElementById('result-overlay'),
                    scoreDisplay: document.getElementById('score-display'),
                    progressFill: document.getElementById('progress-fill'),
                    gameCanvas: document.getElementById('game-stage')
                };

                this.resize = this.resize.bind(this);
                this.initPixi();
                audioController.init();
            }

            initAudioContext() {
                if (window.Howler && Howler.ctx && Howler.ctx.state !== 'running') {
                    Howler.ctx.resume().then(() => {
                        console.log('Audio Context Resumed');
                    });
                }
            }

            initPixi() {
                if (typeof PIXI === 'undefined') {
                    console.error('PIXI.js failed to load');
                    return;
                }

                this.app = new PIXI.Application({
                    view: this.elements.gameCanvas,
                    width: GAME_CONFIG.designWidth,
                    height: GAME_CONFIG.designHeight,
                    backgroundAlpha: 0,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                this.resize();
                window.addEventListener('resize', this.resize);
            }

            resize() {
                if (!this.app || !this.app.view) return;
                
                const w = window.innerWidth;
                const h = window.innerHeight;
                const scale = Math.min(w / GAME_CONFIG.designWidth, h / GAME_CONFIG.designHeight);
                
                const newWidth = GAME_CONFIG.designWidth * scale;
                const newHeight = GAME_CONFIG.designHeight * scale;
                
                this.app.view.style.width = newWidth + 'px';
                this.app.view.style.height = newHeight + 'px';
            }

            hideAllScreens() {
                const screens = [
                    this.elements.startScreen, 
                    this.elements.levelSelectScreen, 
                    this.elements.hud, 
                    this.elements.resultOverlay
                ];
                screens.forEach(el => el.classList.add('hidden'));
            }

            clearStage() {
                if(this.app && this.app.stage) {
                    gsap.killTweensOf(this.app.stage.children);
                    // é€’å½’é”€æ¯å­å¯¹è±¡ï¼Œé‡Šæ”¾æ˜¾å­˜
                    while(this.app.stage.children.length > 0){ 
                        let child = this.app.stage.children[0];
                        this.app.stage.removeChild(child);
                        child.destroy({ children: true, texture: false, baseTexture: false }); 
                    }
                }
            }

            showStartScreen() {
                this.hideAllScreens();
                this.elements.startScreen.classList.remove('hidden');
                this.clearStage();
            }

            showLevelSelect() {
                this.hideAllScreens();
                this.elements.levelSelectScreen.classList.remove('hidden');
                this.renderLevelGrid();
                this.clearStage();
            }

            renderLevelGrid() {
                const container = document.getElementById('level-grid-container');
                container.innerHTML = '';
                
                LEVELS.forEach(level => {
                    // ä¿®æ”¹ç‚¹ï¼šæ‰€æœ‰å…³å¡ç›´æ¥è§£é”ï¼Œä¸å†åˆ¤æ–­ unlockedLevels
                    const isUnlocked = true; 
                    const card = document.createElement('div');
                    card.className = `level-card unlocked`; // å¼ºåˆ¶ä½¿ç”¨è§£é”æ ·å¼
                    
                    const numDiv = document.createElement('div');
                    numDiv.textContent = level.id;
                    numDiv.style.fontSize = "24px";
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = "level-title";
                    titleDiv.textContent = level.title;

                    card.appendChild(numDiv);
                    card.appendChild(titleDiv);
                    
                    if (isUnlocked) {
                        const stars = userProfile.levelStars[level.id] || 0;
                        let starStr = '';
                        for(let i=0; i<3; i++) starStr += (i < stars ? 'â­' : 'â˜†');
                        
                        const starDiv = document.createElement('div');
                        starDiv.className = 'stars-display';
                        starDiv.textContent = starStr;
                        card.appendChild(starDiv);
                        card.onclick = () => this.startLevel(level.id);
                    }
                    container.appendChild(card);
                });
            }

            startLevel(levelId) {
                this.currentLevelId = levelId;
                this.currentLevelData = LEVELS.find(l => l.id === levelId);
                
                // éšæœºæ‰“ä¹±é¢˜ç›®é¡ºåº
                if (this.currentLevelData.content) {
                    this.currentQuestions = shuffleArray([...this.currentLevelData.content]);
                } else {
                    this.currentQuestions = [];
                }

                this.currentQuestionIndex = 0;
                this.score = 0;
                this.correctCount = 0;
                this.isProcessing = false;

                this.hideAllScreens();
                this.elements.hud.classList.remove('hidden');
                
                this.updateHUD();
                this.loadQuestion();
            }

            updateHUD() {
                this.elements.scoreDisplay.textContent = this.score;
                const total = this.currentQuestions.length || 1;
                // é˜²æ­¢è¿˜æ²¡ç­”é¢˜å°±æ˜¾ç¤ºè¿›åº¦
                const progress = (this.currentQuestionIndex / total) * 100;
                this.elements.progressFill.style.width = `${progress}%`;
            }

            loadQuestion() {
                if(!this.app || !this.app.stage) return;
                
                this.clearStage();
                this.isProcessing = false;
                this.app.stage.eventMode = 'auto'; 

                if (this.currentQuestionIndex >= this.currentQuestions.length) {
                    this.finishLevel();
                    return;
                }

                this.updateHUD();
                
                const questionData = this.currentQuestions[this.currentQuestionIndex];
                const levelType = this.currentLevelData.type;

                // æ ¹æ®ç±»å‹æ¸²æŸ“ä¸åŒç©æ³•
                if (levelType === 'identify') this.renderIdentifyLevel(questionData);
                else if (levelType === 'match') this.renderMatchLevel(questionData);
                else if (levelType === 'spell_choice') this.renderSpellLevel(questionData);
            }

            // ç©æ³•1: å¬éŸ³é€‰å­—
            renderIdentifyLevel(data) {
                const playBtn = this.createButton("ğŸ”Š ç‚¹å‡»å¬éŸ³", 512, 150, 0x2196F3);
                playBtn.on('pointerdown', () => {
                    audioController.play(data.audio);
                    gsap.to(playBtn.scale, {x: 1.1, y: 1.1, duration: 0.1, yoyo: true, repeat: 1});
                });
                this.app.stage.addChild(playBtn);
                
                // å»¶è¿Ÿæ’­æ”¾
                setTimeout(() => {
                    // é˜²æ­¢å·²ç»åˆ‡é¢˜è¿˜åœ¨æ’­æ”¾
                    if (this.currentQuestions[this.currentQuestionIndex] === data) {
                        audioController.play(data.audio);
                    }
                }, 500);

                // éšæœºæ‰“ä¹±é€‰é¡¹
                const options = shuffleArray([...data.options]);
                const gap = 200;
                const totalWidth = (options.length - 1) * gap;
                
                options.forEach((opt, index) => {
                    const offsetX = 512 - totalWidth / 2;
                    const card = this.createCard(opt, offsetX + index * gap, 400);
                    
                    card.on('pointerdown', () => {
                        if (this.isProcessing) return;
                        if (opt === data.target) this.handleAnswer(true, card);
                        else this.handleAnswer(false, card);
                    });
                    this.app.stage.addChild(card);
                });

                const text = new PIXI.Text("è¯·é€‰å‡ºå¬åˆ°çš„æ‹¼éŸ³", {fontSize: 36, fill: 0xffffff, fontWeight: 'bold'});
                text.anchor.set(0.5);
                text.position.set(512, 600);
                this.app.stage.addChild(text);
            }

            // ç©æ³•2: ç‚¹å‡»æ¶ˆé™¤ (æ‰¾ç›¸åŒçš„)
            renderMatchLevel(data) {
                const targetChar = data.targetChar;
                const totalCorrect = data.total;
                
                const text = new PIXI.Text(`è¯·ç‚¹å‡»æ‰€æœ‰çš„ '${targetChar}'`, {fontSize: 36, fill: 0xffffff});
                text.anchor.set(0.5);
                text.position.set(512, 100);
                this.app.stage.addChild(text);

                // æ··æ·†é¡¹æ± 
                const chars = ['a','o','e','i','u','Ã¼','b','p','m','f','d','t','n','l'];
                const bubblesData = [];
                for(let i=0; i<totalCorrect; i++) bubblesData.push({val: targetChar, correct: true});
                for(let i=0; i<4; i++) { // 4ä¸ªé”™è¯¯é¡¹
                    let wrong = chars[Math.floor(Math.random()*chars.length)];
                    while(wrong === targetChar) wrong = chars[Math.floor(Math.random()*chars.length)];
                    bubblesData.push({val: wrong, correct: false});
                }
                
                // éšæœºä½ç½®
                const positions = [
                    {x:200, y:300}, {x:400, y:500}, {x:600, y:250}, 
                    {x:800, y:400}, {x:500, y:600}, {x:300, y:650}, {x:700, y:550}
                ];

                let foundCount = 0;
                const currentQIndex = this.currentQuestionIndex;

                // æ‰“ä¹±bubblesData
                shuffleArray(bubblesData);

                bubblesData.forEach((b, i) => {
                    // é˜²æ­¢è¶Šç•Œ
                    if(i >= positions.length) return;
                    
                    const bubble = new PIXI.Container();
                    bubble.position.set(positions[i].x, positions[i].y);
                    
                    const circle = new PIXI.Graphics();
                    circle.beginFill(0xFFFFFF);
                    circle.lineStyle(4, 0x2196F3);
                    circle.drawCircle(0, 0, 50);
                    circle.endFill();
                    
                    const label = new PIXI.Text(b.val, {fontSize: 36, fill: 0x333});
                    label.anchor.set(0.5);
                    
                    bubble.addChild(circle, label);
                    bubble.eventMode = 'static';
                    bubble.cursor = 'pointer';

                    bubble.on('pointerdown', () => {
                        // é˜²æ­¢è·¨é¢˜ç‚¹å‡»
                        if(this.currentQuestionIndex !== currentQIndex) return; 

                        if (b.correct) {
                            if (bubble.alpha < 1) return; // å·²ç»å¤„ç†è¿‡çš„å¿½ç•¥
                            
                            bubble.eventMode = 'none';
                            circle.tint = GAME_CONFIG.colors.success;
                            audioController.play(b.val);
                            
                            gsap.to(bubble.scale, {x: 0, y: 0, duration: 0.5, delay: 0.2, onComplete: () => {
                                bubble.alpha = 0; 
                            }});
                            
                            foundCount++;
                            this.score += 10;
                            this.elements.scoreDisplay.textContent = this.score;
                            
                            if (foundCount >= totalCorrect) {
                                this.correctCount++;
                                setTimeout(() => {
                                    if(this.currentQuestionIndex === currentQIndex) this.nextQuestion();
                                }, 800);
                            }
                        } else {
                            audioController.play('wrong');
                            circle.tint = GAME_CONFIG.colors.error;
                            // ä¿®æ­£ï¼šé”™è¯¯åæ¢å¤é¢œè‰²ï¼Œå¦åˆ™ä¸€ç›´çº¢è‰²
                            gsap.to(bubble, {x: bubble.x + 10, duration: 0.05, yoyo: true, repeat: 3, onComplete: () => {
                                circle.tint = 0xFFFFFF; // æ¢å¤ç™½è‰²
                            }});
                        }
                    });

                    this.app.stage.addChild(bubble);
                    gsap.to(bubble, {y: positions[i].y - 20, duration: 2 + Math.random(), yoyo: true, repeat: -1, ease: "sine.inOut"});
                });
            }

            // ç©æ³•3: æ‹¼è¯»/è§„åˆ™é€‰æ‹©é¢˜
            renderSpellLevel(data) {
                const wordBg = new PIXI.Graphics();
                wordBg.beginFill(0xFFFFFF);
                wordBg.drawRoundedRect(-200, -60, 400, 120, 20);
                wordBg.endFill();
                wordBg.position.set(512, 150);
                
                const wordText = new PIXI.Text(data.display, {fontSize: 40, fill: 0x333, align: 'center'});
                wordText.anchor.set(0.5);
                wordBg.addChild(wordText);
                this.app.stage.addChild(wordBg);

                // éšæœºæ‰“ä¹±é€‰é¡¹
                const options = shuffleArray([...data.options]);

                const startY = 300;
                options.forEach((opt, index) => {
                    const btnHeight = 70;
                    const btn = this.createButton(opt, 512, startY + index * (btnHeight + 20), 0xFFCC80, 400, btnHeight);
                    
                    btn.on('pointerdown', () => {
                        if (this.isProcessing) return;
                        
                        // ç®€å•å¤„ç†ï¼šå¦‚æœæ˜¯ iu å¹¶åˆ—è§„åˆ™ï¼Œç›´æ¥åˆ¤æ–­æ–‡æœ¬
                        if (data.target === "ui") {
                             if (opt.includes("iuå¹¶åˆ—æ ‡åœ¨å")) this.handleAnswer(true, btn);
                             else this.handleAnswer(false, btn);
                             return;
                        }

                        // é€šç”¨é€»è¾‘ï¼šå¦‚æœæ˜¯ç›´æ¥å…¨ç­‰
                        if (opt === data.target) {
                             this.handleAnswer(true, btn);
                        }
                        // å¦‚æœæ˜¯æ‹¼è¯»è¿çº¿ï¼ˆå¦‚ b-aï¼‰ï¼Œå»æ‰-åç­‰äº target (ba)
                        else if (opt.replace(/-/g,"") === data.target) {
                             this.handleAnswer(true, btn);
                        }
                        // ç‰¹æ®Šä¿®æ­£
                        else if (data.target === "ma1" && opt === "mÄ") this.handleAnswer(true, btn);
                        else if (data.target === "ma2" && opt === "mÃ¡") this.handleAnswer(true, btn);
                        else if (data.target === "ma3" && opt === "mÇ") this.handleAnswer(true, btn);
                        else if (data.target === "ma4" && opt === "mÃ ") this.handleAnswer(true, btn);
                        
                        // id: 21 ç‰¹æ®Šé¢˜
                        else if (data.target === "gui" && opt === "guÄ«") this.handleAnswer(true, btn); 
                        else if (data.target === "lei" && opt === "l-ei") this.handleAnswer(true, btn);

                        // id: 23 ä¸‰æ‹¼
                        else if (data.target === "gua" && opt === "g-u-a") this.handleAnswer(true, btn);
                        else if (data.target === "hua" && opt === "h-u-a") this.handleAnswer(true, btn);
                        else if (data.target === "xiong" && opt === "x-i-ong") this.handleAnswer(true, btn);

                        else this.handleAnswer(false, btn);
                    });
                    this.app.stage.addChild(btn);
                });
            }

            createCard(textStr, x, y) {
                const container = new PIXI.Container();
                container.position.set(x, y);
                
                const bg = new PIXI.Graphics();
                bg.beginFill(GAME_CONFIG.colors.cardBg);
                bg.lineStyle(4, 0xCCCCCC);
                bg.drawRoundedRect(-60, -80, 120, 160, 15);
                bg.endFill();
                
                container._customBg = bg;

                const shadow = new PIXI.Graphics();
                shadow.beginFill(0x000000, 0.2);
                shadow.drawRoundedRect(-55, -75, 120, 160, 15);
                shadow.endFill();
                
                container.addChild(shadow); 
                container.addChild(bg);

                const text = new PIXI.Text(textStr, {
                    fontSize: 50, // ç¨å¾®è°ƒå°ä¸€ç‚¹é€‚åº”æ›´å¤šå­—æ¯
                    fill: GAME_CONFIG.colors.text,
                    fontFamily: "Arial",
                    fontWeight: "bold"
                });
                text.anchor.set(0.5);
                container.addChild(text);

                container.eventMode = 'static'; 
                container.cursor = 'pointer';
                container.on('pointerover', () => { if(bg) bg.tint = 0xFFF9C4; });
                container.on('pointerout', () => { if(bg) bg.tint = 0xFFFFFF; });

                return container;
            }

            createButton(label, x, y, color, w=200, h=60) {
                const container = new PIXI.Container();
                container.position.set(x, y);

                const bg = new PIXI.Graphics();
                bg.beginFill(color);
                bg.drawRoundedRect(-w/2, -h/2, w, h, h/2);
                bg.endFill();
                
                container._customBg = bg;
                
                const text = new PIXI.Text(label, {fontSize: 24, fill: 0xFFFFFF, fontWeight: 'bold'});
                text.anchor.set(0.5);
                
                container.addChild(bg, text);
                container.eventMode = 'static';
                container.cursor = 'pointer';
                return container;
            }

            handleAnswer(isCorrect, targetObj) {
                if (this.isProcessing) return; // åŒé‡ä¿é™©
                
                this.isProcessing = true;
                this.app.stage.eventMode = 'static'; // ä¸´æ—¶ç¦ç”¨å…¨å±€äº‹ä»¶é˜²æ­¢è¿ç‚¹ï¼Œä½†å…è®¸åŠ¨ç”»è¿è¡Œ
                
                const bg = targetObj._customBg || targetObj.children[0]; 

                if (isCorrect) {
                    if(bg) bg.tint = GAME_CONFIG.colors.success;
                    gsap.to(targetObj.scale, {x: 1.1, y: 1.1, duration: 0.2, yoyo: true, repeat: 1});
                    
                    audioController.play('correct');
                    this.score += 20;
                    this.correctCount++;

                    setTimeout(() => {
                        this.nextQuestion();
                    }, 1000);

                } else {
                    const originalTint = bg ? bg.tint : 0xFFFFFF;
                    if(bg) bg.tint = GAME_CONFIG.colors.error;
                    audioController.play('wrong');

                    gsap.to(targetObj, {x: targetObj.x + 10, duration: 0.05, yoyo: true, repeat: 5, onComplete: () => {
                        if(bg) bg.tint = originalTint;
                        this.isProcessing = false;
                        if(this.app && this.app.stage) this.app.stage.eventMode = 'auto'; 
                    }});
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.loadQuestion();
            }

            finishLevel() {
                this.hideAllScreens();
                this.elements.resultOverlay.classList.remove('hidden');
                
                let accuracy = 0;
                if (this.currentQuestions.length > 0) {
                     accuracy = this.correctCount / this.currentQuestions.length;
                }
                
                let stars = 1;
                if (accuracy > 0.6) stars = 2;
                if (accuracy > 0.9) stars = 3;

                const starStr = "â­".repeat(stars);
                document.getElementById('result-stars').textContent = starStr;
                
                let msg = "è¿˜éœ€åŠªåŠ›å“¦ï¼";
                if (stars === 2) msg = "çœŸæ£’ï¼Œç»§ç»­åŠ æ²¹ï¼";
                if (stars === 3) msg = "å¤ªå‰å®³äº†ï¼Œæ‹¼éŸ³å°çŠ¶å…ƒï¼";
                document.getElementById('result-msg').textContent = msg;

                userProfile.levelStars[this.currentLevelId] = Math.max(userProfile.levelStars[this.currentLevelId] || 0, stars);
                
                const nextBtn = document.getElementById('next-level-btn');
                if (this.currentLevelId >= LEVELS.length) {
                    nextBtn.style.display = 'none';
                } else {
                    nextBtn.style.display = 'block';
                }
            }

            nextLevel() {
                if (this.currentLevelId < LEVELS.length) {
                    this.startLevel(this.currentLevelId + 1);
                } else {
                    this.showLevelSelect();
                }
            }

            exitLevel() {
                this.showLevelSelect();
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå®ä¾‹åŒ–
        window.onload = () => {
            if (!gameApp) {
                gameApp = new GameApp();
            }
        };

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å­¦è¯­æ–‡ï¼šé€‰å­—å¡«ç©ºå¤§é—¯å…³</title>
    <!-- å¼•å…¥ Confetti ç‰¹æ•ˆåº“ (ä¸¥æ ¼éµå®ˆ CDN è§„åˆ™: cdn.jsdelivr.net) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* é…è‰²æ–¹æ¡ˆï¼šä¿æŒé«˜é¥±å’Œåº¦çš„ç³–æœè‰²ç³» */
            --primary-color: #FF6B6B;      /* æ´»åŠ›çº¢ */
            --secondary-color: #4ECDC4;    /* æ¸…æ–°ç»¿ */
            --accent-color: #FFD93D;       /* æ˜äº®é»„ */
            --text-color: #2C3E50;         /* æ·±è“é»‘ */
            --board-bg: #FFFDF5;           /* ç±³é»„çº¸å¼ è‰² */
            --success-color: #6BCB77;      /* æˆåŠŸç»¿ */
            --error-color: #FF6B6B;        /* é”™è¯¯çº¢ */
            --slot-bg: #FFFFFF;            /* å¡«ç©ºæ§½èƒŒæ™¯ */
            --font-main: "KaiTi", "STKaiti", "Microsoft YaHei", sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none; 
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%, #FECFEF 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #game-container {
            width: 95%;
            max-width: 850px;
            height: 95%;
            max-height: 900px;
            background-color: var(--board-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 8px solid #FFF;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
            overflow: hidden;
        }

        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        #header {
            padding: 15px 20px;
            background: #FFD93D;
            border-bottom: 4px solid #F4C430;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* å…è®¸å°å±æ¢è¡Œ */
            gap: 10px;
            font-size: 1.1rem;
            color: #5D4037;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .level-indicator {
            background: #FFF;
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #5D4037;
            font-weight: bold;
            font-size: 1.2rem;
            white-space: nowrap;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-info {
            display: flex;
            gap: 15px;
            font-weight: bold;
            background: rgba(255,255,255,0.6);
            padding: 5px 15px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .score-display { color: #FF6B6B; }
        .star-display { color: #F39C12; text-shadow: 1px 1px 0 #FFF; }

        /* å°æŒ‰é’®æ ·å¼ */
        .btn-small {
            background: #FFF;
            border: 2px solid #BDC3C7;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 0.9rem;
            color: #5D4037;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 0 #BDC3C7;
            transition: all 0.1s;
        }
        .btn-small:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .btn-restart {
            border-color: #E74C3C;
            color: #C0392B;
            box-shadow: 0 2px 0 #C0392B;
        }
        .btn-random {
            border-color: #3498DB;
            color: #2980B9;
            box-shadow: 0 2px 0 #2980B9;
        }

        /* --- æ¸¸æˆä¸»åŒºåŸŸ --- */
        #game-board {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            background-image: radial-gradient(#E0E0E0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #question-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 20px;
            font-size: 1.6rem;
        }

        .question-row {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #EAEAEA;
            box-shadow: 0 6px 0 #E0E0E0; 
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            transition: transform 0.2s;
            line-height: 1.8;
        }

        .question-row:hover {
            transform: translateY(-2px);
        }

        /* å¡«ç©ºæ§½ä½ */
        .slot {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-width: 3rem;
            width: auto;
            height: 3rem;
            padding: 0 5px;
            background-color: var(--slot-bg);
            border: 3px dashed #BDC3C7;
            margin: 0 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.8rem;
            vertical-align: middle;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            white-space: nowrap;
        }

        .slot.active {
            border-color: var(--secondary-color);
            border-style: solid;
            background-color: #E0F2F1;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.4);
        }

        .slot.filled-correct {
            color: #FFF;
            background-color: var(--success-color);
            border: none;
            box-shadow: 0 4px 0 #4CA859;
            animation: pop 0.4s ease-out;
            cursor: default;
        }

        .slot.filled-wrong {
            color: #FFF;
            background-color: var(--error-color);
            border: none;
            animation: shake 0.4s ease-in-out;
        }

        /* é€‰é¡¹åŒºåŸŸ */
        #options-area {
            flex-shrink: 0;
            min-height: 140px;
            background: #4ECDC4;
            border-top: 6px solid #3AAFA9;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* é€‰é¡¹å¡ç‰‡ */
        .option-card {
            min-width: 70px;
            width: auto;
            padding: 0 15px;
            height: 70px;
            background: #fff;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 0 #BDC3C7, 0 10px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .option-card:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #BDC3C7, inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .option-card.selected {
            background-color: var(--accent-color);
            color: #5D4037;
            box-shadow: 0 6px 0 #F39C12, 0 10px 15px rgba(243, 156, 18, 0.3);
            transform: translateY(-8px);
        }

        /* --- å¼¹çª—/é®ç½©å±‚ --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #fff;
            text-align: center;
            padding: 20px;
        }

        .overlay.active { display: flex; }

        .modal-box {
            background: #fff;
            color: var(--text-color);
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 420px;
            border: 6px solid #4ECDC4;
            box-shadow: 0 10px 0 #3AAFA9;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        h1 { 
            color: var(--primary-color);
            text-shadow: 2px 2px 0 #FFD5D5;
            font-size: 2rem;
            margin: 0 0 15px 0;
        }
        
        h2 { margin: 0 0 15px 0; color: var(--success-color); }
        p { margin-bottom: 25px; font-size: 1.2rem; line-height: 1.6; }

        .btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-size: 1.4rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: var(--font-main);
            font-weight: bold;
            box-shadow: 0 6px 0 #D94545;
            transition: transform 0.1s;
            outline: none;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }

        .btn:active { transform: translateY(6px); box-shadow: 0 0 0 #D94545; }
        .btn-green { background: var(--secondary-color); box-shadow: 0 6px 0 #3AAFA9; }
        .btn-green:active { box-shadow: 0 0 0 #3AAFA9; }

        /* --- åŠ¨ç”» Keyframes --- */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-5deg); }
            40% { transform: translateX(8px) rotate(5deg); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* --- å“åº”å¼é€‚é… --- */
        @media (min-width: 768px) {
            #game-container {
                height: 90vh;
                border-radius: 30px;
                border-width: 10px;
            }
            #game-board {
                flex-direction: row;
            }
            #question-area { 
                flex: 3; 
                padding-right: 25px; 
                border-right: 4px dashed #BDC3C7; 
            }
            #options-area { 
                flex: 1; 
                flex-direction: column; 
                border-top: none; 
                border-left: none;
                background: transparent;
                justify-content: flex-start;
                padding-top: 60px;
            }
            .question-row { font-size: 2rem; padding: 25px; }
            .slot { min-width: 4rem; height: 4rem; font-size: 2.2rem; margin: 0 10px; border-radius: 16px; border-width: 4px; }
            .option-card { min-width: 90px; height: 90px; font-size: 2.8rem; border-radius: 20px; }
            
            #header { padding: 20px 30px; }
            .btn-small { padding: 8px 15px; font-size: 1rem; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- å¤´éƒ¨ -->
    <header id="header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="level-indicator">ç¬¬ <span id="current-level-num">1</span> å…³</div>
            <div class="header-controls">
                <button type="button" class="btn-small btn-restart" onclick="game.returnToStart()" title="å›åˆ°å¼€å§‹ç•Œé¢">â†º é‡æ¥</button>
                <button type="button" class="btn-small btn-random" onclick="game.startRandomLevel()" title="éšæœºè¿›å…¥ä¸€å…³">ğŸ² éšæœº</button>
            </div>
        </div>
        <div class="header-info">
            <span class="score-display">å¾—åˆ†: <span id="score-num">0</span></span>
            <span class="star-display">â˜… x <span id="star-num">0</span></span>
        </div>
    </header>

    <!-- æ¸¸æˆåŒºåŸŸ -->
    <main id="game-board">
        <div id="question-area">
            <!-- é¢˜ç›®å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
        </div>
        <div id="options-area">
            <!-- é€‰é¡¹å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
        </div>
    </main>

    <!-- å¼€å§‹ç•Œé¢ -->
    <div id="start-screen" class="overlay active">
        <div class="modal-box">
            <h1>ğŸ’ é€‰å­—å¡«ç©ºå¤§é—¯å…³</h1>
            <p>
                å°æœ‹å‹ï¼Œæ¬¢è¿æ¥åˆ°æ±‰å­—ä¹å›­ï¼<br>
                è¿™æ¬¡æœ‰æ›´å¤šé•¿å¾—å¾ˆåƒçš„å­—å®å®ã€‚<br>
                å¿«æ¥å¸®å®ƒä»¬æ‰¾åˆ°æ­£ç¡®çš„å®¶å§ï¼
            </p>
            <button class="btn" onclick="game.start()">å‡ºå‘ï¼</button>
        </div>
    </div>

    <!-- ç»“ç®—ç•Œé¢ -->
    <div id="level-complete-screen" class="overlay">
        <div class="modal-box">
            <h2>ğŸ‰ é—¯å…³æˆåŠŸï¼</h2>
            <p id="level-feedback">å¤ªæ£’äº†ï¼Œä½ çœŸèªæ˜ï¼</p>
            <div style="font-size: 4rem; color: #FFD93D; margin-bottom: 20px; text-shadow: 0 4px 0 #E67E22;">
                â˜…â˜…â˜…
            </div>
            <button class="btn btn-green" onclick="game.nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>

    <!-- é€šå…³ç•Œé¢ -->
    <div id="game-end-screen" class="overlay">
        <div class="modal-box">
            <h1>ğŸ† è¯†å­—å°çŠ¶å…ƒ</h1>
            <p>æ­å–œä½ ï¼æ‰€æœ‰çš„ç»ƒä¹ é¢˜éƒ½å®Œæˆäº†ï¼<br>ä½ å·²ç»æ˜¯æ±‰å­—å°ä¸“å®¶å•¦ï¼</p>
            <p style="font-size: 1.5rem; color: #FF6B6B; font-weight: bold;">æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
            <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
</div>

<script>
    /**
     * æ¸¸æˆæ•°æ®é…ç½®
     */
    const LEVELS = [
        {
            id: 1,
            title: "è¾¨æï¼šå’Œ / ç¦¾",
            options: ["å’Œ", "ç¦¾"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"å’Œ"}, {text:"æ°”"}] },
                { parts: [{text:""}, {slot:true, ans:"ç¦¾"}, {text:"è‹—"}] },
                { parts: [{text:""}, {slot:true, ans:"ç¦¾"}, {text:"ç”°"}] },
                { parts: [{text:""}, {slot:true, ans:"å’Œ"}, {text:"å¥½"}] }
            ]
        },
        {
            id: 2,
            title: "è¾¨æï¼šåŠ› / ç«‹",
            options: ["åŠ›", "ç«‹"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"ç«‹"}, {text:"æ­£"}] },
                { parts: [{text:""}, {slot:true, ans:"åŠ›"}, {text:"æ°”"}] },
                { parts: [{text:"ç«™"}, {slot:true, ans:"ç«‹"}, {text:""}] },
                { parts: [{text:"ç”¨"}, {slot:true, ans:"åŠ›"}, {text:""}] }
            ]
        },
        {
            id: 3,
            title: "è¾¨æï¼šçŸ³ / å",
            options: ["çŸ³", "å"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"å"}, {text:"æœˆ"}] },
                { parts: [{text:""}, {slot:true, ans:"çŸ³"}, {text:"å­"}] },
                { parts: [{text:"å±±"}, {slot:true, ans:"çŸ³"}, {text:""}] },
                { parts: [{text:"ä¸‰"}, {slot:true, ans:"å"}, {text:""}] }
            ]
        },
        {
            id: 4,
            title: "è¾¨æï¼šä» / è™«",
            options: ["ä»", "è™«"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"ä»"}, {text:"æ¥"}] },
                { parts: [{text:""}, {slot:true, ans:"ä»"}, {text:"å‰"}] },
                { parts: [{text:"å°"}, {slot:true, ans:"è™«"}, {text:""}] },
                { parts: [{text:"é’"}, {slot:true, ans:"è™«"}, {text:""}] }
            ]
        },
        {
            id: 5,
            title: "è¾¨æï¼šå‡  / å·±",
            options: ["å‡ ", "å·±"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"å‡ "}, {text:"ä¸ª"}] },
                { parts: [{text:"è‡ª"}, {slot:true, ans:"å·±"}, {text:""}] },
                { parts: [{text:""}, {slot:true, ans:"å‡ "}, {text:"å¤©"}] },
                { parts: [{text:""}, {slot:true, ans:"å‡ "}, {text:"ç‰‡å¶å­"}] } 
            ]
        },
        {
            id: 6,
            title: "è¾¨æï¼šå­— / è‡ª / å­",
            options: ["å­—", "è‡ª", "å­"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"è‡ª"}, {text:"å·±"}] },
                { parts: [{text:"å„¿"}, {slot:true, ans:"å­"}, {text:""}] },
                { parts: [{text:""}, {slot:true, ans:"è‡ª"}, {text:"æˆ‘"}] },
                { parts: [{text:"å†™"}, {slot:true, ans:"å­—"}, {text:""}] }
            ]
        },
        {
            id: 7,
            title: "è¾¨æï¼šæœ‰ / å‹",
            options: ["æœ‰", "å‹"],
            tasks: [
                { parts: [{text:"å¥½"}, {slot:true, ans:"å‹"}, {text:""}] },
                { parts: [{text:""}, {slot:true, ans:"æœ‰"}, {text:"ç”¨"}] },
                { parts: [{text:""}, {slot:true, ans:"æœ‰"}, {text:"æ— "}] },
                { parts: [{text:"æœ‹"}, {slot:true, ans:"å‹"}, {text:""}] }
            ]
        },
        {
            id: 8,
            title: "è¾¨æï¼šé‡Œ / ä½ ",
            options: ["é‡Œ", "ä½ "],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"ä½ "}, {text:"å¥½"}] },
                { parts: [{text:""}, {slot:true, ans:"ä½ "}, {text:"ä»¬"}] },
                { parts: [{text:""}, {slot:true, ans:"é‡Œ"}, {text:"å¤´"}] },
                { parts: [{text:"èˆ¹"}, {slot:true, ans:"é‡Œ"}, {text:""}] }
            ]
        },
        {
            id: 9,
            title: "å¥å­ï¼šæœ¨ / ç›®",
            options: ["æœ¨", "ç›®"],
            tasks: [
                { parts: [{text:"ä¸Šè¯¾æ—¶ï¼Œæˆ‘æ€»æ˜¯"}, {slot:true, ans:"ç›®"}, {text:"ä¸è½¬ç›åœ°ç›¯ç€é»‘æ¿ã€‚"}] },
                { parts: [{text:"æˆ‘å–œæ¬¢åƒé»‘"}, {slot:true, ans:"æœ¨"}, {text:"è€³ã€‚"}] }
            ]
        },
        {
            id: 10,
            title: "å¥å­ï¼šå° / å°‘",
            options: ["å°", "å°‘"],
            tasks: [
                { parts: [{text:"è¿™ä¸ªè‹¹æœå¾ˆ"}, {slot:true, ans:"å°"}, {text:"ã€‚"}] },
                { parts: [{text:"ä»Šå¤©ä½ å­¦äº†å¤š"}, {slot:true, ans:"å°‘"}, {text:"ä¸ªç”Ÿå­—ï¼Ÿ"}] }
            ]
        },
        {
            id: 11,
            title: "è¾¨æï¼šåˆ / æœ‰",
            options: ["åˆ", "æœ‰"],
            tasks: [
                { parts: [{text:"æˆ‘å›½"}, {slot:true, ans:"æœ‰"}, {text:"äº”åå…­ä¸ªæ°‘æ—ã€‚"}] },
                { parts: [{text:"è¿‡äº†æ–°å¹´ï¼Œæˆ‘"}, {slot:true, ans:"åˆ"}, {text:"å¤§äº†ä¸€å²ã€‚"}] }
            ]
        },
        {
            id: 12,
            title: "å¥å­ï¼šå’Œ / ç¦¾",
            options: ["å’Œ", "ç¦¾"],
            tasks: [
                { parts: [{text:"ç”°é‡Œçš„"}, {slot:true, ans:"ç¦¾"}, {text:"è‹—ç»¿æ²¹æ²¹çš„ã€‚"}] },
                { parts: [{text:"æˆ‘"}, {slot:true, ans:"å’Œ"}, {text:"å¦ˆå¦ˆå»å…¬å›­ç©ã€‚"}] }
            ]
        },
        {
            id: 13,
            title: "å¥å­ï¼šå‡  / å·±",
            options: ["å‡ ", "å·±"],
            tasks: [
                { parts: [{text:"æ¡Œå­ä¸Šæ”¾ç€"}, {slot:true, ans:"å‡ "}, {text:"æœ¬ä¹¦ã€‚"}] },
                { parts: [{text:"æ˜ŸæœŸå¤©ï¼Œæˆ‘è‡ª"}, {slot:true, ans:"å·±"}, {text:"æ¥åˆ°äº†å¥¶å¥¶å®¶ã€‚"}] }
            ]
        },
        {
            id: 14,
            title: "ç»¼åˆï¼šå·´/æŠŠ/ç™½/è‡ª",
            options: ["å·´", "æŠŠ", "ç™½", "è‡ª"],
            tasks: [
                { parts: [{text:"å°å¦¹å¦¹æœ€å–œæ¬¢ç©æ³¥"}, {slot:true, ans:"å·´"}, {text:"ã€‚"}] },
                { parts: [{text:"æˆ‘"}, {slot:true, ans:"æŠŠ"}, {text:""}, {slot:true, ans:"è‡ª"}, {text:"å·±çš„"}, {slot:true, ans:"ç™½"}, {text:"è£™å­æ´—å¹²å‡€äº†ã€‚"}] }
            ]
        },
        {
            id: 15,
            title: "ç»¼åˆï¼šä¸Š/é•¿/å±±",
            options: ["ä¸Š", "é•¿", "å±±"],
            tasks: [
                { parts: [{text:"ä¸‡é‡Œ"}, {slot:true, ans:"é•¿"}, {text:"åŸåƒä¸€æ¡å·¨é¾™ã€‚"}] },
                { parts: [{text:""}, {slot:true, ans:"å±±"}, {text:""}, {slot:true, ans:"ä¸Š"}, {text:"æœ‰ä¸€æ£µé«˜å¤§çš„æ¾æ ‘ã€‚"}] }
            ]
        },
        {
            id: 16,
            title: "ç»¼åˆï¼šå‡/å£°/ç”Ÿ",
            options: ["å‡", "å£°", "ç”Ÿ"],
            tasks: [
                { parts: [{text:"å›½æ­Œ"}, {slot:true, ans:"å£°"}, {text:"ä¸­ï¼Œçº¢æ——å¾å¾"}, {slot:true, ans:"å‡"}, {text:"èµ·ã€‚"}] },
                { parts: [{text:"æˆ‘ä»¬çš„"}, {slot:true, ans:"ç”Ÿ"}, {text:"æ´»å¤šä¹ˆå¹¸ç¦ã€‚"}] }
            ]
        },
        {
            id: 17,
            title: "è¾¨æï¼šæ˜¨ / ä½œ",
            options: ["æ˜¨", "ä½œ"],
            tasks: [
                { parts: [{text:""}, {slot:true, ans:"æ˜¨"}, {text:"å¤©ä¸€å›åˆ°å®¶ï¼Œæˆ‘å°±å¼€å§‹åš"}, {slot:true, ans:"ä½œ"}, {text:"ä¸šã€‚"}] }
            ]
        },
        {
            id: 18,
            title: "é€‰è¯å¡«ç©ºï¼šé•¿é•¿ / å¸¸å¸¸",
            options: ["é•¿é•¿", "å¸¸å¸¸"],
            tasks: [
                { parts: [{text:"å¤§è±¡é•¿ç€"}, {slot:true, ans:"é•¿é•¿"}, {text:"çš„é¼»å­ã€‚"}] },
                { parts: [{text:"å“¥å“¥"}, {slot:true, ans:"å¸¸å¸¸"}, {text:"å»ä¹¦åº—ä¹°ä¹¦ã€‚"}] }
            ]
        },
        {
            id: 19,
            title: "è¾¨æï¼šè¶³ / èµ°",
            options: ["è¶³", "èµ°"],
            tasks: [
                { parts: [{text:"è¿‡é©¬è·¯è¦"}, {slot:true, ans:"èµ°"}, {text:"äººè¡Œé“ã€‚"}] },
                { parts: [{text:"å¹³å¹³å»è¸¢"}, {slot:true, ans:"è¶³"}, {text:"çƒã€‚"}] }
            ]
        },
        {
            id: 20,
            title: "è¾¨æï¼šè§ / è´",
            options: ["è§", "è´"],
            tasks: [
                { parts: [{text:"å°çº¢çœ‹"}, {slot:true, ans:"è§"}, {text:"æ²™æ»©ä¸Šæœ‰è®¸å¤šæ¼‚äº®çš„"}, {slot:true, ans:"è´"}, {text:"å£³ã€‚"}] }
            ]
        },
        {
            id: 21,
            title: "è¾¨æï¼šæŠŠ / å·´",
            options: ["æŠŠ", "å·´"],
            tasks: [
                { parts: [{text:"é¸­å­çš„å°¾"}, {slot:true, ans:"å·´"}, {text:"æ‰ã€‚"}] },
                { parts: [{text:"æˆ‘"}, {slot:true, ans:"æŠŠ"}, {text:"ä½œä¸šå†™å®Œäº†ã€‚"}] }
            ]
        }
    ];

    /**
     * éŸ³é¢‘ç®¡ç†å™¨ (ä½¿ç”¨ AudioContext ç”Ÿæˆç®€å•éŸ³æ•ˆ)
     */
    class AudioManager {
        constructor() {
            this.ctx = null;
        }

        init() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!this.ctx) {
                this.ctx = new AudioContext();
            } else if (this.ctx.state === 'suspended') {
                this.ctx.resume().catch(() => {});
            }
        }

        playTone(type) {
            if (!this.ctx) return;
            if (this.ctx.state === 'suspended') {
                this.ctx.resume().catch(() => {});
            }

            const now = this.ctx.currentTime;
            
            if (type === 'correct') {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'wrong') {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'win') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    this.playNote(freq, i * 0.15);
                });
            }
        }

        playNote(freq, delay) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            const now = this.ctx.currentTime;
            
            osc.frequency.value = freq;
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.1, now + delay);
            gain.gain.exponentialRampToValueAtTime(0.01, now + delay + 0.5);
            osc.start(now + delay);
            osc.stop(now + delay + 0.5);
        }
    }

    /**
     * æ¸¸æˆä¸»é€»è¾‘æ§åˆ¶å™¨
     */
    class GameController {
        constructor() {
            this.state = {
                currentLevelIndex: 0,
                score: 0,
                stars: 0,
                currentSelection: null,
                isRandomMode: false
            };
            this.audio = new AudioManager();
            
            this.dom = {
                questionArea: document.getElementById('question-area'),
                optionsArea: document.getElementById('options-area'),
                levelNum: document.getElementById('current-level-num'),
                scoreNum: document.getElementById('score-num'),
                starNum: document.getElementById('star-num'),
                screens: {
                    start: document.getElementById('start-screen'),
                    complete: document.getElementById('level-complete-screen'),
                    end: document.getElementById('game-end-screen')
                },
                finalScore: document.getElementById('final-score')
            };
        }

        start() {
            this.audio.init(); 
            this.dom.screens.start.classList.remove('active');
            this.state.isRandomMode = false;
            // æ¯æ¬¡ç‚¹å‡»å¼€å§‹éƒ½ä»ç¬¬ä¸€å…³å¼€å§‹
            this.loadLevel(0);
        }

        loadLevel(index) {
            if (index >= LEVELS.length) {
                this.endGame();
                return;
            }

            this.state.currentLevelIndex = index;
            this.state.currentSelection = null;
            const levelData = LEVELS[index];

            this.dom.levelNum.textContent = index + 1;
            this.renderQuestions(levelData.tasks);
            this.renderOptions(levelData.options);
        }

        // ä¿®æ”¹åçš„é‡æ¥åŠŸèƒ½ï¼šå›åˆ°åˆå§‹ç•Œé¢å¹¶é‡ç½®æ•°æ®
        returnToStart() {
            this.audio.playNote(600, 0); 
            // é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®
            this.state.score = 0;
            this.state.stars = 0;
            this.state.currentLevelIndex = 0;
            this.state.isRandomMode = false;
            this.updateUI();

            // éšè—ç»“ç®—æˆ–é€šå…³ç•Œé¢ï¼ˆå¦‚æœæœ‰ï¼‰
            this.dom.screens.complete.classList.remove('active');
            this.dom.screens.end.classList.remove('active');
            
            // æ˜¾ç¤ºå¼€å§‹ç•Œé¢
            this.dom.screens.start.classList.add('active');
        }

        // éšæœºå…³å¡æ¨¡å¼
        startRandomLevel() {
            this.audio.playNote(500, 0); 
            this.audio.init(); // ç¡®ä¿éšæœºå¼€å§‹ä¹Ÿèƒ½åˆå§‹åŒ–éŸ³é¢‘
            this.state.isRandomMode = true;
            // éšè—å¯èƒ½å­˜åœ¨çš„å¼€å§‹ç•Œé¢
            this.dom.screens.start.classList.remove('active');
            this.dom.screens.complete.classList.remove('active');
            
            let randomIndex;
            // å¾ªç¯ç”Ÿæˆéšæœºç´¢å¼•ï¼Œç›´åˆ°å’Œå½“å‰å…³å¡ç´¢å¼•ä¸åŒ
            do {
                randomIndex = Math.floor(Math.random() * LEVELS.length);
                // è¾¹ç•Œä¿æŠ¤ï¼šå¦‚æœåªæœ‰1ä¸ªå…³å¡ï¼Œç›´æ¥ä½¿ç”¨å½“å‰ç´¢å¼•ï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰
            } while (randomIndex === this.state.currentLevelIndex && LEVELS.length > 1);
            
            this.loadLevel(randomIndex);
        }

        renderQuestions(tasks) {
            this.dom.questionArea.innerHTML = '';
            
            tasks.forEach((task, tIndex) => {
                const row = document.createElement('div');
                row.className = 'question-row';
                // ä½¿ç”¨çŸ­æ—¶åŠ¨ç”»
                row.style.animation = `bounceIn 0.5s ease-out ${tIndex * 0.1}s both`;
                
                task.parts.forEach((part, pIndex) => {
                    if (part.slot) {
                        const slot = document.createElement('div');
                        slot.className = 'slot';
                        slot.dataset.ans = part.ans;
                        slot.dataset.id = `t${tIndex}-p${pIndex}`;
                        slot.onclick = () => this.handleSlotClick(slot);
                        row.appendChild(slot);
                    } else {
                        const textSpan = document.createElement('span');
                        textSpan.textContent = part.text;
                        row.appendChild(textSpan);
                    }
                });
                
                this.dom.questionArea.appendChild(row);
            });
        }

        renderOptions(options) {
            this.dom.optionsArea.innerHTML = '';
            
            options.forEach(char => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.textContent = char;
                card.onclick = () => this.selectOption(card, char);
                this.dom.optionsArea.appendChild(card);
            });
        }

        selectOption(cardElement, char) {
            const prev = document.querySelector('.option-card.selected');
            if (prev) prev.classList.remove('selected');

            if (this.state.currentSelection === char && prev === cardElement) {
                this.state.currentSelection = null;
                document.querySelectorAll('.slot:not(.filled-correct)').forEach(slot => {
                    slot.classList.remove('active');
                });
                return;
            }

            this.state.currentSelection = char;
            cardElement.classList.add('selected');

            document.querySelectorAll('.slot:not(.filled-correct)').forEach(slot => {
                slot.classList.add('active');
            });
            
            this.audio.playNote(400, 0);
        }

        handleSlotClick(slot) {
            if (slot.classList.contains('filled-correct')) return;

            if (!this.state.currentSelection) {
                this.dom.optionsArea.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-5px)' },
                    { transform: 'translateX(5px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
                return;
            }

            const answer = slot.dataset.ans;
            const userChoice = this.state.currentSelection;

            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));

            if (userChoice === answer) {
                this.handleCorrect(slot, userChoice);
            } else {
                this.handleWrong(slot, userChoice);
            }
        }

        handleCorrect(slot, char) {
            slot.textContent = char;
            slot.classList.remove('filled-wrong');
            slot.classList.add('filled-correct');
            
            this.audio.playTone('correct');
            
            this.state.score += 10;
            this.updateUI();

            this.checkLevelCompletion();
        }

        handleWrong(slot, char) {
            slot.textContent = char;
            slot.classList.add('filled-wrong');
            
            this.audio.playTone('wrong');

            setTimeout(() => {
                slot.textContent = '';
                slot.classList.remove('filled-wrong');
                if (this.state.currentSelection) {
                     document.querySelectorAll('.slot:not(.filled-correct)').forEach(s => s.classList.add('active'));
                }
            }, 600);
        }

        checkLevelCompletion() {
            const totalSlots = document.querySelectorAll('.slot').length;
            const filledSlots = document.querySelectorAll('.slot.filled-correct').length;

            if (filledSlots === totalSlots) {
                setTimeout(() => {
                    this.showLevelComplete();
                }, 800);
            }
        }

        updateUI() {
            this.dom.scoreNum.textContent = this.state.score;
            this.dom.starNum.textContent = this.state.stars;
        }

        showLevelComplete() {
            this.audio.playTone('win');
            this.state.stars += 1;
            this.updateUI();
            
            if (typeof confetti === 'function') {
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6 },
                    colors: ['#FF6B6B', '#4ECDC4', '#FFD93D']
                });
            }

            this.dom.screens.complete.classList.add('active');
        }

        nextLevel() {
            this.dom.screens.complete.classList.remove('active');
            
            if (this.state.isRandomMode) {
                // å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œç»§ç»­éšæœº
                this.startRandomLevel();
            } else {
                // æ­£å¸¸é¡ºåºæ¨¡å¼
                this.loadLevel(this.state.currentLevelIndex + 1);
            }
        }

        endGame() {
            this.dom.finalScore.textContent = this.state.score;
            this.dom.screens.end.classList.add('active');
            
            if (typeof confetti === 'function') {
                const duration = 3000;
                const end = Date.now() + duration;

                (function frame() {
                    confetti({
                        particleCount: 5,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: ['#FF6B6B', '#FFD93D']
                    });
                    confetti({
                        particleCount: 5,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: ['#4ECDC4', '#FFF']
                    });
                
                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                }());
            }
        }
    }

    // å¯åŠ¨æ¸¸æˆå®ä¾‹
    const game = new GameController();

</script>
</body>
</html>